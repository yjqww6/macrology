
<html>
 <head>
  <title>local-expand该怎么用</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <style>body {
  max-width: 1200px;
  margin-left: auto;
  margin-right: auto;
  font-family: "Open Sans","Clear Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
  line-height: 1.6;
  color: rgb(51,51,51);
}
div#whole {
  margin: 10px;
}
h1,h2 {
  border-bottom: solid thin lightgray;
}
ol,ul {
  margin: 0.8em 0;
  padding-left: 30px;
}
div.outer {
  border: solid 1px rgb(243,244,246);
  border-radius: 3px;
  margin: 10px 0 10px 0;
}
pre {
  margin: 0;
  word-wrap: break-word;
  white-space: pre-wrap;
  background: rgb(246,248,250);
  border: solid 1px rgb(239,241,242);
  border-radius: 3px;
  line-height: 1.3;
}
code.racket {
  font-family: 'Fira-Mono', monospace;
}
code.parenthesis {
  color: rgb(132,60,36);
}
code.symbol {
  color: rgb(38, 38, 128);
}
code.hash-colon-keyword {
  color: rgb(132, 60, 36);
}
code.string,code.constant {
  color: rgb(41, 128, 38);
}
code.comment,code.sexp-comment {
  color: rgb(192, 116, 31);
}</style></head>
 <body>
  <div id="whole">
   <h1 id="local-expand该怎么用">local-expand该怎么用</h1>
   <h2 id="什么时候需要用local-expand">什么时候需要用local-expand</h2>
   <ul>
    <li>
     <p>什么时候会用到<span><code class="racket symbol">local-expand</code></span>?</p>
     <p>当需要对展开结果立即进行进一步操作的时候。</p></li>
    <li>
     <p>什么时候要用<span><code class="racket symbol">local-expand</code></span>，而不是<span><code class="racket symbol">local-apply-transformer</code></span>？</p>
     <p>如果要展开的对象是一个可以在指定的上下文里直接运行的定义或表达式，则需要用<span><code class="racket symbol">local-expand</code></span>；如果是一些不能运行的pattern，用<span><code class="racket symbol">local-apply-transformer</code></span>。</p></li></ul>
   <h2 id="参数怎么选">参数怎么选</h2>
   <h3 id="局部的完全展开与expression-context">局部的完全展开与Expression Context</h3>
   <p>当<span><code class="racket symbol">stop-ids</code></span>参数选择<span><code class="racket symbol">null</code></span> 时，<span><code class="racket symbol">context-v</code></span>一般是<span><code class="racket constant">'</code><code class="racket symbol">expression</code></span>。也就是说，局部的完全展开需要 <em>expression context</em> 。而如果当前的<span><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-context</code><code class="racket parenthesis">)</code></span>不是<span><code class="racket constant">'</code><code class="racket symbol">expression</code></span>时，则需要延迟到 <em>expression context</em> 。</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">local</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">e</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket parenthesis">(</code><code class="racket symbol">local-expand</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">e</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">expression</code><code class="racket"> </code><code class="racket symbol">null</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">new</code><code class="racket">
 </code><code class="racket parenthesis">(</code><code class="racket symbol">class</code><code class="racket"> </code><code class="racket symbol">object%</code><code class="racket">
   </code><code class="racket parenthesis">(</code><code class="racket symbol">super-new</code><code class="racket parenthesis">)</code><code class="racket">
   </code><code class="racket parenthesis">(</code><code class="racket symbol">define/public</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">a</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket">
   </code><code class="racket parenthesis">(</code><code class="racket symbol">local</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">displayln</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">a</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket comment">;;; class: misuse of method (not in application) in: a</code></pre></div>
   <p>这个例子中，<span><code class="racket symbol">local</code></span>的展开是一个 <em>internal definition context</em> ，意味着环境还没有设置完毕，但却进行了完全展开，因此出现问题。</p>
   <p>正确写法：用<span><code class="racket symbol">#%expression</code></span>延迟到 <em>expression context</em> 再展开</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket

</code><code class="racket comment">;;;也可以直接用make-expression-transformer</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">local</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">e</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket parenthesis">(</code><code class="racket symbol">eq?</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-context</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">expression</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket parenthesis">(</code><code class="racket symbol">local-expand</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">e</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">expression</code><code class="racket"> </code><code class="racket symbol">null</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket symbol">form</code><code class="racket">
     </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">#%expression</code><code class="racket"> </code><code class="racket symbol">form</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">new</code><code class="racket">
 </code><code class="racket parenthesis">(</code><code class="racket symbol">class</code><code class="racket"> </code><code class="racket symbol">object%</code><code class="racket">
   </code><code class="racket parenthesis">(</code><code class="racket symbol">super-new</code><code class="racket parenthesis">)</code><code class="racket">
   </code><code class="racket parenthesis">(</code><code class="racket symbol">define/public</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">a</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket">
   </code><code class="racket parenthesis">(</code><code class="racket symbol">local</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">displayln</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">a</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code></pre></div>
   <p>那么什么时候要用功能类似的<span><code class="racket symbol">syntax-local-expand-expression</code></span>呢？情况可以分为以下几种</p>
   <ul>
    <li>
     <p>需要改写结果</p>
     <p>用<span><code class="racket symbol">local-expand</code></span>。</p></li>
    <li>
     <p>结果不变，但需要放进其他binding form里，导致引入新的local <em>scope</em> 。例如<span><code class="racket symbol">let</code></span>的<span><code class="racket symbol">body</code></span>和<span><code class="racket symbol">letrec</code></span>的<span><code class="racket symbol">body</code></span>及<span><code class="racket symbol">rhs</code></span>。</p>
     <p>用<span><code class="racket symbol">local-expand</code></span>。</p>
     <p>典型例子是<span><code class="racket symbol">place/context</code></span>：其会用<span><code class="racket symbol">local-expand</code></span>展开<span><code class="racket symbol">body</code></span>，再计算出其中的自由变量。而展开的<span><code class="racket symbol">body</code></span>放进一些let之类的东西里面，使得这些名字在结果里会重新绑定到place channel传进来的参数里，意义发生了变化。因此这种情况不适用<span><code class="racket symbol">syntax-local-expand-expression</code></span>。</p></li>
    <li>
     <p>结果不变，直接返回或在不引入新的local <em>scope</em> 情况下返回。</p>
     <p>用<span><code class="racket symbol">syntax-local-expand-expression</code></span>。至于是不是<span><code class="racket symbol">opaque-only?</code></span>，则看是否需要对结果进行其他操作。</p></li></ul>
   <h3 id="其他的完全展开">其他的完全展开</h3>
   <p>一般是在实现新的<span><code class="racket symbol">#%module-begin</code></span>时使用，此时<span><code class="racket symbol">context-v</code></span>是<span><code class="racket constant">'</code><code class="racket symbol">module-begin</code></span>，<span><code class="racket symbol">stop-ids</code></span>一般是<span><code class="racket parenthesis">(</code><code class="racket symbol">list</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">module*</code><code class="racket parenthesis">)</code></span>或<span><code class="racket symbol">null</code></span>。</p>
   <h3 id="部分展开">部分展开</h3>
   <p>部分展开的情况就比较混乱了，没有固定的用法，这里只能简单总结一下。</p>
   <ul>
    <li>在 <em>internal definition context</em> 展开的情况，一般是配合 <em>first class internal definition context</em> 使用，<span><code class="racket symbol">stop-ids</code></span>至少应包括<span><code class="racket symbol">define-values</code></span>、<span><code class="racket symbol">define-syntaxes</code></span>和<span><code class="racket symbol">begin</code></span>。详细可见<a href="intdef-ctx.html">如何使用First Class Internal Definition Context</a>。</li></ul>
   <h3 id="部分展开-vs-完全展开">部分展开 vs 完全展开</h3>
   <p>在 <em>definition context</em> 做宏展开时，一般要经历两个pass：</p>
   <ol>
    <li>对宏进行部分展开，这一步碰到<span><code class="racket symbol">define-values</code></span>、<span><code class="racket symbol">define-syntaxes</code></span>或者其他 <em>Fully Expanded Program</em> 的form就会停下。这一步会建立环境，该 <em>definition context</em> 下的 <em>binding</em> 都是这一步引入的。</li>
    <li>完全展开。</li></ol>
   <p>如上面的例子所示的，在1做完全展开会因为环境缺失出现问题。同理，在1时使用<span><code class="racket symbol">identifier-binding</code></span>也可能得不到准确的结果。在2时试图修改环境也会出现问题，从一些设计中可以看出来：</p>
   <ul>
    <li>
     <p><span><code class="racket symbol">syntax-local-lift-module-end-declaration</code></span>如果不在步骤1中使用，会在 <em>expression context</em> 展开其参数，导致无法引入 <em>binding</em> 。</p>
     <div class="outer">
      <pre class="brush: racket"><code class="racket">#lang racket
</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket parenthesis">(</code><code class="racket symbol">begin</code><code class="racket">
       </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-lift-module-end-declaration</code><code class="racket">
        </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
       </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">λ</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">+</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code></pre></div>
     <p>这段代码可以正常展开，但如果把<span><code class="racket symbol">f</code></span>的展开延迟到完全展开的时候：</p>
     <div class="outer">
      <pre class="brush: racket"><code class="racket">#lang racket
</code><code class="racket parenthesis">(</code><code class="racket symbol">require</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">for-syntax</code><code class="racket"> </code><code class="racket symbol">syntax/transformer</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket symbol">f</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">make-expression-transformer</code><code class="racket">
   </code><code class="racket parenthesis">(</code><code class="racket symbol">λ</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
       </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket">
        </code><code class="racket parenthesis">(</code><code class="racket symbol">begin</code><code class="racket">
          </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-lift-module-end-declaration</code><code class="racket">
           </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
          </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">λ</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">+</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code></pre></div>
     <p>这时就会出现<span><code class="racket symbol">x:</code><code class="racket"> </code><code class="racket symbol">unbound</code><code class="racket"> </code><code class="racket symbol">identifier</code></span>。因为这时要修改环境，添加 <em>binding</em> 已经太迟了。即便不使用定义的<span><code class="racket symbol">id</code></span>：</p>
     <div class="outer">
      <pre class="brush: racket"><code class="racket">#lang racket
</code><code class="racket parenthesis">(</code><code class="racket symbol">require</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">for-syntax</code><code class="racket"> </code><code class="racket symbol">syntax/transformer</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket symbol">f</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">make-expression-transformer</code><code class="racket">
   </code><code class="racket parenthesis">(</code><code class="racket symbol">λ</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
       </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket">
        </code><code class="racket parenthesis">(</code><code class="racket symbol">begin</code><code class="racket">
          </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-lift-module-end-declaration</code><code class="racket">
           </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
          </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">λ</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code></pre></div>也会出现<span><code class="racket symbol">define:</code><code class="racket"> </code><code class="racket symbol">not</code><code class="racket"> </code><code class="racket symbol">allowed</code><code class="racket"> </code><code class="racket symbol">in</code><code class="racket"> </code><code class="racket symbol">an</code><code class="racket"> </code><code class="racket symbol">expression</code><code class="racket"> </code><code class="racket symbol">context</code></span>。</li>
    <li>其他能在2改变环境的手段，如<span><code class="racket symbol">syntax-local-lift-expression</code></span>、<span><code class="racket symbol">syntax-local-lift-require</code></span>都会引入新的scope来确保只有新展开的代码能看到引入的 <em>binding</em> 。</li></ul>
   <p>另一方面，部分展开会把 <em>Fully Expanded Program</em> 的结构也加入<span><code class="racket symbol">stop-ids</code></span>，这也导致只能展开最外层的syntax。</p>
   <h2 id="什么时候要对local-expand的结果用syntax-disarm">什么时候要对local-expand的结果用syntax-disarm</h2>
   <p>在对结果进行操作时，如果只对最外层的名字进行检测不把拆开的结果返回，或者只拆开<span><code class="racket symbol">begin</code></span> <span><code class="racket symbol">begin-for-syntax</code></span> <span><code class="racket symbol">#%plain-module-begin</code></span> <span><code class="racket symbol">define-values</code></span> <span><code class="racket symbol">define-syntaxes</code></span>，则不需要<span><code class="racket symbol">syntax-disarm</code></span>。</p>
   <p>如果还要再进一步拆开里面的syntax对象，需要先对其使用<span><code class="racket symbol">syntax-disarm</code></span>，再对返回值使用<span><code class="racket symbol">syntax-rearm</code></span>。<span><code class="racket symbol">inspector</code></span>使用module声明时的inspector，可通过<span><code class="racket parenthesis">(</code><code class="racket symbol">variable-reference-&gt;module-declaration-inspector</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">#%variable-reference</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code></span>获得。</p>
   <p>补充：8.2.0.4之后，不再需要使用<span><code class="racket symbol">syntax-disarm</code></span>。</p>
   <h2 id="使用示例">使用示例</h2>
   <p>如果要写这样一个宏<span><code class="racket parenthesis">(</code><code class="racket symbol">let-box</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket symbol">rhs</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">body</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code></span>：如果<span><code class="racket symbol">x</code></span>在<span><code class="racket symbol">body</code></span>里没有被<span><code class="racket symbol">set!</code></span>过，那么就跟普通的<span><code class="racket symbol">let</code></span>一样；如果被<span><code class="racket symbol">set!</code></span>过了，那么<span><code class="racket symbol">x</code></span>被放到box里，并且所有对x的引用变成<span><code class="racket symbol">unbox</code></span> ，所有对<span><code class="racket symbol">x</code></span>的赋值变成<span><code class="racket symbol">set-box!</code></span>。</p>
   <p>应该怎么写呢？</p>
   <ol>
    <li><span><code class="racket symbol">x</code></span>有没有<span><code class="racket symbol">set</code></span>!过，需要<span><code class="racket symbol">body</code></span>完全展开之后才能得知，所以需要用<span><code class="racket symbol">local-expand</code></span>进行完全展开</li>
    <li>需要完全展开，所以延迟到 <em>expression context</em></li>
    <li>要记录<span><code class="racket symbol">set!</code></span>的情况，可以把x的名字绑定到一个 <em>set!-transformer</em> ，在里面通知<span><code class="racket symbol">let-box</code></span>。这个过程可以用 <em>3d syntax</em> 简单地完成。</li>
    <li>因为没有被<span><code class="racket symbol">set!</code></span>的情况下等于普通的<span><code class="racket symbol">let</code></span>，可以利用<span><code class="racket symbol">syntax-local-expand-expression</code></span>进行优化。</li>
    <li>被<span><code class="racket symbol">set!</code></span>过了的话，要对展开结果进行修改，因此需要<span><code class="racket symbol">syntax-disarm</code></span>。</li></ol>
   <p>终上所述，<span><code class="racket symbol">let-box</code></span>写出来如下：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket
</code><code class="racket parenthesis">(</code><code class="racket symbol">require</code><code class="racket"> </code><code class="racket symbol">syntax/parse/define</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax-parser</code><code class="racket"> </code><code class="racket symbol">let-box</code><code class="racket">
  </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">x:id</code><code class="racket"> </code><code class="racket symbol">rhs</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">body</code><code class="racket"> </code><code class="racket symbol">...+</code><code class="racket parenthesis">)</code><code class="racket">
   </code><code class="racket hash-colon-keyword">#:when</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">eq?</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-context</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">expression</code><code class="racket parenthesis">)</code><code class="racket">
   </code><code class="racket hash-colon-keyword">#:do</code><code class="racket"> </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">setted?</code><code class="racket"> </code><code class="racket constant">#f</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket">
   </code><code class="racket hash-colon-keyword">#:with</code><code class="racket"> </code><code class="racket symbol">proc</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">datum-&gt;syntax</code><code class="racket"> </code><code class="racket constant">#f</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">λ</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">set!</code><code class="racket"> </code><code class="racket symbol">setted?</code><code class="racket"> </code><code class="racket constant">#t</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
   </code><code class="racket hash-colon-keyword">#:do</code><code class="racket"> </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">define-values</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">expanded</code><code class="racket"> </code><code class="racket symbol">opaque</code><code class="racket parenthesis">)</code><code class="racket"> 
           </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-expand-expression</code><code class="racket">
            </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">let</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket symbol">rhs</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
                </code><code class="racket parenthesis">(</code><code class="racket symbol">let-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">make-set!-transformer</code><code class="racket">
                                 </code><code class="racket parenthesis">(</code><code class="racket symbol">lambda</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
                                   </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">set!</code><code class="racket parenthesis">)</code><code class="racket">
                                     </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">set!</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">v</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">begin</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket constant">'</code><code class="racket symbol">proc</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">set!</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket symbol">v</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket">
                                     </code><code class="racket parenthesis">[</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">identifier?</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket">  </code><code class="racket constant">#'</code><code class="racket symbol">x</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
                  </code><code class="racket symbol">body</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket">
   </code><code class="racket parenthesis">(</code><code class="racket symbol">cond</code><code class="racket">
     </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">not</code><code class="racket"> </code><code class="racket symbol">setted?</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">opaque</code><code class="racket parenthesis">]</code><code class="racket">
     </code><code class="racket parenthesis">[</code><code class="racket symbol">else</code><code class="racket">
      </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">insp</code><code class="racket">
        </code><code class="racket parenthesis">(</code><code class="racket symbol">variable-reference-&gt;module-declaration-inspector</code><code class="racket">
         </code><code class="racket parenthesis">(</code><code class="racket symbol">#%variable-reference</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
      </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-disarm</code><code class="racket"> </code><code class="racket symbol">expanded</code><code class="racket"> </code><code class="racket symbol">insp</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">let-values</code><code class="racket parenthesis">)</code><code class="racket">
        </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">let-values</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">rhs</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">body</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket">
         </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-rearm</code><code class="racket">
          </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">let</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">box</code><code class="racket"> </code><code class="racket symbol">rhs</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
              </code><code class="racket parenthesis">(</code><code class="racket symbol">let-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">make-set!-transformer</code><code class="racket">
                               </code><code class="racket parenthesis">(</code><code class="racket symbol">lambda</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
                                 </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">set!</code><code class="racket parenthesis">)</code><code class="racket">
                                   </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">set!</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">v</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">set-box!</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket symbol">v</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket">
                                   </code><code class="racket parenthesis">[</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">identifier?</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket">  </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">unbox</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
                </code><code class="racket symbol">body</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
          </code><code class="racket symbol">expanded</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket">
  </code><code class="racket parenthesis">[</code><code class="racket symbol">form</code><code class="racket">
   </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">#%expression</code><code class="racket"> </code><code class="racket symbol">form</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code></pre></div>
   <p>使用如下：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket symbol">&gt;</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">let-box</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
           </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket constant">1</code><code class="racket">
</code><code class="racket symbol">&gt;</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">let-box</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
           </code><code class="racket parenthesis">(</code><code class="racket symbol">set!</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">2</code><code class="racket parenthesis">)</code><code class="racket">
           </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket constant">2</code><code class="racket">
</code><code class="racket symbol">&gt;</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-&gt;datum</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">expand</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket parenthesis">(</code><code class="racket symbol">let-box</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
                                   </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket constant">'</code><code class="racket parenthesis">(</code><code class="racket symbol">#%expression</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">let-values</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">(</code><code class="racket parenthesis">(</code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">let-values</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">let-values</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket symbol">&gt;</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-&gt;datum</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">expand</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket parenthesis">(</code><code class="racket symbol">let-box</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
                                   </code><code class="racket parenthesis">(</code><code class="racket symbol">set!</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">2</code><code class="racket parenthesis">)</code><code class="racket">
                                   </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket constant">'</code><code class="racket parenthesis">(</code><code class="racket symbol">#%expression</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">let-values</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">(</code><code class="racket parenthesis">(</code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">#%app</code><code class="racket"> </code><code class="racket symbol">box</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">let-values</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
      </code><code class="racket parenthesis">(</code><code class="racket symbol">let-values</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">let-values</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">let-values</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">#%app</code><code class="racket"> </code><code class="racket symbol">set-box!</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket constant">2</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">#%app</code><code class="racket"> </code><code class="racket symbol">unbox</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code></pre></div></div></body></html>