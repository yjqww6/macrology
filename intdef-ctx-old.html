
<html>
 <head>
  <title>如何使用First Class Internal Definition Context</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <style>body {
  max-width: 1200px;
  margin-left: auto;
  margin-right: auto;
  font-family: "Open Sans","Clear Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
  line-height: 1.6;
  color: rgb(51,51,51);
}
div#whole {
  margin: 10px;
}
h1,h2 {
  border-bottom: solid thin lightgray;
}
ol,ul {
  margin: 0.8em 0;
  padding-left: 30px;
}
div.outer {
  border: solid 1px rgb(243,244,246);
  border-radius: 3px;
  margin: 10px 0 10px 0;
}
pre {
  margin: 0;
  word-wrap: break-word;
  white-space: pre-wrap;
  background: rgb(246,248,250);
  border: solid 1px rgb(239,241,242);
  border-radius: 3px;
  line-height: 1.3;
}
code.racket {
  font-family: 'Fira-Mono', monospace;
}
code.parenthesis {
  color: rgb(132,60,36);
}
code.symbol {
  color: rgb(38, 38, 128);
}
code.hash-colon-keyword {
  color: rgb(132, 60, 36);
}
code.string,code.constant {
  color: rgb(41, 128, 38);
}
code.comment,code.sexp-comment {
  color: rgb(192, 116, 31);
}</style></head>
 <body>
  <div id="whole">
   <h1 id="如何使用first-class-internal-definition-context">如何使用First Class Internal Definition Context</h1>
   <p>Racket的 <em>first class internal definition context</em> 是一个利器，主要用途有：</p>
   <ul>
    <li>可以用来对定义进行变换：</li></ul>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket

</code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">a%</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">class</code><code class="racket"> </code><code class="racket symbol">object%</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">define/match</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">fact</code><code class="racket"> </code><code class="racket symbol">n</code><code class="racket parenthesis">)</code><code class="racket">
      </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket constant">0</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket parenthesis">]</code><code class="racket">
      </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">n</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">*</code><code class="racket"> </code><code class="racket symbol">n</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">fact</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">sub1</code><code class="racket"> </code><code class="racket symbol">n</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">public</code><code class="racket"> </code><code class="racket symbol">fact</code><code class="racket parenthesis">)</code><code class="racket">
    
    </code><code class="racket parenthesis">(</code><code class="racket symbol">super-new</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">send</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">new</code><code class="racket"> </code><code class="racket symbol">a%</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">fact</code><code class="racket"> </code><code class="racket constant">5</code><code class="racket parenthesis">)</code></pre></div>
   <p>在这个例子中，类<span><code class="racket symbol">a%</code></span>定义了一个<span><code class="racket symbol">fact</code></span>方法，用的是<span><code class="racket symbol">define/match</code></span>，而不需要一个特别定制的“define-method”宏。从函数定义到类的方法需要经过复杂的变换过程，但是<span><code class="racket symbol">define/match</code></span>自身是不知道自己会被用来定义方法的。 <em>First class internal definition context</em> 使其成为了可能。</p>
   <ul>
    <li>可以立即为局部的展开设置所需环境，而不需要推迟到后续的宏展开</li></ul>
   <h2 id="应用示例">应用示例</h2>
   <p>假设需要写这样一个宏：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket parenthesis">(</code><code class="racket symbol">define-record</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">foo</code><code class="racket"> </code><code class="racket symbol">l</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">match-define</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">list</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">y</code><code class="racket"> </code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">z</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">l</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code></pre></div>
   <p>需要展开为</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket parenthesis">(</code><code class="racket symbol">struct</code><code class="racket"> </code><code class="racket symbol">foo</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket symbol">y</code><code class="racket"> </code><code class="racket symbol">z</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">make-foo</code><code class="racket"> </code><code class="racket symbol">l</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">match-define</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">list</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">y</code><code class="racket"> </code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">z</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">l</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">foo</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket symbol">y</code><code class="racket"> </code><code class="racket symbol">z</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code></pre></div>
   <p>也就是一次性从 <em>definition context</em> 中得到<span><code class="racket symbol">struct</code></span>的字段和构造函数。</p>
   <h3 id="实现">实现</h3>
   <h4 id="准备工作">准备工作</h4>
   <p>从定义开始：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax-parser</code><code class="racket"> </code><code class="racket symbol">define-record</code><code class="racket">
  </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">name:id</code><code class="racket"> . </code><code class="racket symbol">args:formals</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">body:expr</code><code class="racket"> </code><code class="racket symbol">...+</code><code class="racket parenthesis">)</code><code class="racket">
   </code><code class="racket symbol">&lt;...&gt;</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code></pre></div>
   <p>这里无疑要利用 <em>first class internal definition context</em> （以下简称 <em>intdef-ctx</em> ）对<span><code class="racket symbol">body</code></span>进行操作了，但首先，参数的args的 <em>binding</em> 还没有设置好。</p>
   <p>因此，上述的第二个用途，设置环境：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">param-ctx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-make-definition-context</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-bind-syntaxes</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-&gt;list</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">args.params</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">#f</code><code class="racket"> </code><code class="racket symbol">param-ctx</code><code class="racket parenthesis">)</code></pre></div>
   <p>这里<span><code class="racket symbol">param-ctx</code></span>提供一个包含了args的 <em>binding</em> 的环境，防止出现变量未定义或是访问到外层定义的同名 <em>binding</em> 。</p>
   <p>接下来定义<span><code class="racket symbol">body</code></span>的 <em>intdef-ctx</em> ：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">body-ctx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-make-definition-context</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code></pre></div>
   <p>这里<span><code class="racket symbol">parent-ctx</code></span>为什么是默认的<span><code class="racket constant">#f</code></span>，不是<span><code class="racket symbol">param-ctx</code></span>呢？因为<span><code class="racket symbol">parent-ctx</code></span>中的 <em>binding</em> 默认不可见，作为代替，后面展开的时候传一个list。</p>
   <p>接下来看看怎么对<span><code class="racket symbol">body</code></span>进行展开，首先是<span><code class="racket symbol">local-expand</code></span>的使用：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">ctx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">list</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">gensym</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">expand</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">local-expand</code><code class="racket">
   </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket symbol">ctx</code><code class="racket">
   </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-&gt;list</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">begin</code><code class="racket"> </code><code class="racket symbol">define-values</code><code class="racket"> </code><code class="racket symbol">define-syntaxes</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
   </code><code class="racket parenthesis">(</code><code class="racket symbol">list</code><code class="racket"> </code><code class="racket symbol">body-ctx</code><code class="racket"> </code><code class="racket symbol">param-ctx</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code></pre></div>
   <p>因为<span><code class="racket symbol">body</code></span>的定义不需对外可见，<span><code class="racket symbol">context-v</code></span>使用<span><code class="racket parenthesis">(</code><code class="racket symbol">list</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">gensym</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code></span>，否则可以用<span><code class="racket symbol">generate-expand-context</code></span>。然后因为遇到的定义可能会相互或递归引用，必须部分展开，这里的<span><code class="racket symbol">stop-ids</code></span>这三基本上是 <em>intdef-ctx</em> 展开不可少的，如果要其他特殊功能（例如，一个标记不需要变成结构体字段的定义的“ignore”宏），才会添加别的。<span><code class="racket symbol">body-ctx</code></span>和<span><code class="racket symbol">param-ctx</code></span>两个环境都要访问，因此都要传进去。</p>
   <h4 id="递归展开">递归展开</h4>
   <p>接下来要对<span><code class="racket symbol">body</code></span>进行递归展开，先定义收集字段的变量：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">defined-ids</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code></pre></div>
   <p>开始遍历：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket parenthesis">(</code><code class="racket symbol">let</code><code class="racket"> </code><code class="racket symbol">loop</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">begin</code><code class="racket"> </code><code class="racket symbol">body</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-parse</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">expand</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket hash-colon-keyword">#:literals</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">begin</code><code class="racket"> </code><code class="racket symbol">define-values</code><code class="racket"> </code><code class="racket symbol">define-syntaxes</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket symbol">&lt;...&gt;</code><code class="racket">
  </code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket"> </code></pre></div>
   <ul>
    <li>遇到<span><code class="racket symbol">begin</code></span>的情况，直接递归：</li></ul>
   <div class="outer">
    <pre class="brush: racket"><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">begin</code><code class="racket"> </code><code class="racket symbol">form</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket">
 </code><code class="racket hash-colon-keyword">#:with</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">expanded-form</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">stx-map</code><code class="racket"> </code><code class="racket symbol">loop</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">form</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
 </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">begin</code><code class="racket"> </code><code class="racket symbol">expanded-form</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code></pre></div>
   <ul>
    <li>遇到<span><code class="racket symbol">define-values</code></span>的情况：</li></ul>
   <div class="outer">
    <pre class="brush: racket"><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">define-values</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">ids</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">expr</code><code class="racket parenthesis">)</code><code class="racket">
 </code><code class="racket hash-colon-keyword">#:with</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">bd</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">stx-map</code><code class="racket"> </code><code class="racket symbol">syntax-local-identifier-as-binding</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">ids</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
 </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-bind-syntaxes</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-&gt;list</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">bd</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">#f</code><code class="racket"> </code><code class="racket symbol">body-ctx</code><code class="racket parenthesis">)</code><code class="racket">
 </code><code class="racket parenthesis">(</code><code class="racket symbol">set!</code><code class="racket"> </code><code class="racket symbol">defined-ids</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">append</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-&gt;list</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">bd</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">defined-ids</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
 </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">define-values</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">bd</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">expr</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code></pre></div>
   <p>这里就需要对<span><code class="racket symbol">body-ctx</code></span>操作了。首先<span><code class="racket symbol">syntax-local-identifier-as-binding</code></span>是去除<span><code class="racket symbol">ids</code></span>的 <em>use-site scope</em> ，为什么需要这个步骤呢？因为每次<span><code class="racket symbol">local-expand</code></span>可能引入不同的 <em>use-site scope</em> ，要使<span><code class="racket symbol">ids</code></span>对其他定义可见，必须要去除 <em>use-site scope</em> 。然后，用<span><code class="racket symbol">syntax-local-bind-syntaxes</code></span>将去除了 <em>use-site scope</em> 的名字添加到<span><code class="racket symbol">body-ctx</code></span>中。</p>
   <ul>
    <li>遇到<span><code class="racket symbol">define-syntaxes</code></span>的情况：</li></ul>
   <div class="outer">
    <pre class="brush: racket"><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntaxes</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">ids</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">expr</code><code class="racket parenthesis">)</code><code class="racket">
 </code><code class="racket hash-colon-keyword">#:with</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">bd</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">stx-map</code><code class="racket"> </code><code class="racket symbol">syntax-local-identifier-as-binding</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">ids</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
 </code><code class="racket hash-colon-keyword">#:with</code><code class="racket"> </code><code class="racket symbol">rhs</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">local-transformer-expand</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">expr</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">expression</code><code class="racket"> </code><code class="racket symbol">null</code><code class="racket"> </code><code class="racket symbol">body-ctx</code><code class="racket parenthesis">)</code><code class="racket">
 </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-bind-syntaxes</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-&gt;list</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">bd</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">rhs</code><code class="racket"> </code><code class="racket symbol">body-ctx</code><code class="racket parenthesis">)</code><code class="racket">
 </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntaxes</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">bd</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">rhs</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code></pre></div>
   <p>这里和上面不一样的是<span><code class="racket symbol">expr</code></span>会被马上执行，而且要做完全展开。因为<span><code class="racket symbol">body</code></span>自身不是完全展开，所以<span><code class="racket symbol">define-record</code></span>的结果里仍可能会有对这些局部定义的宏的引用。为了避免<span><code class="racket symbol">expr</code></span>被展开 <strong>两次</strong> ，这里先做完全展开。</p>
   <ul>
    <li>其他情况直接返回：</li></ul>
   <div class="outer">
    <pre class="brush: racket"><code class="racket parenthesis">[</code><code class="racket symbol">form</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">form</code><code class="racket parenthesis">]</code></pre></div>
   <h4 id="收尾">收尾</h4>
   <p>按照要求的结构返回syntax对象。</p>
   <p>注意这里的<span><code class="racket symbol">args-scoped</code></span>，需要使用<span><code class="racket symbol">internal-definition-context-introduce</code></span>让<span><code class="racket symbol">args</code></span>带上<span><code class="racket symbol">param-ctx</code></span>的scope，然后body的名字才能解析到新的定义。</p>
   <p>这是因为<span><code class="racket symbol">args</code></span>是从宏的参数提供的，原本不含有<span><code class="racket symbol">param-ctx</code></span>的scope。而<span><code class="racket symbol">syntax-local-bind-syntaxes</code></span>会把intdef-ctx参数的scope添加到创建的 <em>binding</em> 中。</p>
   <p>因此，如果直接将<span><code class="racket symbol">args</code></span>放入结果中，最终的scope set不是<span><code class="racket symbol">param-ctx</code></span>里对应的 <em>binding</em> 的scope set的超集，将导致“ambigious binding”。</p>
   <p>相对地，后面<span><code class="racket symbol">syntax-local-bind-syntaxes</code></span>所用的 <em>identifier</em> 是从展开结果中获取的，需要<span><code class="racket symbol">syntax-local-identifier-as-binding</code></span>。</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket hash-colon-keyword">#:with</code><code class="racket"> </code><code class="racket symbol">ctor-body</code><code class="racket"> </code><code class="racket symbol">&lt;上面展开的结果&gt;</code><code class="racket">
</code><code class="racket hash-colon-keyword">#:with</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">field</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">defined-ids</code><code class="racket">
</code><code class="racket hash-colon-keyword">#:with</code><code class="racket"> </code><code class="racket symbol">ctor</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">format-id</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">name</code><code class="racket"> </code><code class="racket string">"make-~a"</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">name</code><code class="racket"> </code><code class="racket hash-colon-keyword">#:subs?</code><code class="racket"> </code><code class="racket constant">#t</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket hash-colon-keyword">#:with</code><code class="racket"> </code><code class="racket symbol">args-scoped</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">internal-definition-context-introduce</code><code class="racket"> </code><code class="racket symbol">param-ctx</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">args</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">begin</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">struct</code><code class="racket"> </code><code class="racket symbol">name</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">field</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
         </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">ctor</code><code class="racket"> . </code><code class="racket symbol">args-scoped</code><code class="racket parenthesis">)</code><code class="racket">
           </code><code class="racket symbol">ctor-body</code><code class="racket">
           </code><code class="racket parenthesis">(</code><code class="racket symbol">name</code><code class="racket"> </code><code class="racket symbol">field</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code></pre></div>
   <h4 id="完整代码">完整代码</h4>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket
</code><code class="racket parenthesis">(</code><code class="racket symbol">require</code><code class="racket"> </code><code class="racket symbol">syntax/parse/define</code><code class="racket">
         </code><code class="racket parenthesis">(</code><code class="racket symbol">for-syntax</code><code class="racket"> </code><code class="racket symbol">syntax/parse/lib/function-header</code><code class="racket"> </code><code class="racket symbol">syntax/stx</code><code class="racket"> </code><code class="racket symbol">racket/syntax</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax-parser</code><code class="racket"> </code><code class="racket symbol">define-record</code><code class="racket">
  </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">name:id</code><code class="racket"> . </code><code class="racket symbol">args:formals</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">body:expr</code><code class="racket"> </code><code class="racket symbol">...+</code><code class="racket parenthesis">)</code><code class="racket">
   </code><code class="racket hash-colon-keyword">#:do</code><code class="racket">
   </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">param-ctx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-make-definition-context</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">body-ctx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-make-definition-context</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-bind-syntaxes</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-&gt;list</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">args.params</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">#f</code><code class="racket"> </code><code class="racket symbol">param-ctx</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">ctx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">list</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">gensym</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">expand</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
      </code><code class="racket parenthesis">(</code><code class="racket symbol">local-expand</code><code class="racket">
       </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket symbol">ctx</code><code class="racket">
       </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-&gt;list</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">begin</code><code class="racket"> </code><code class="racket symbol">define-values</code><code class="racket"> </code><code class="racket symbol">define-syntaxes</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
       </code><code class="racket parenthesis">(</code><code class="racket symbol">list</code><code class="racket"> </code><code class="racket symbol">body-ctx</code><code class="racket"> </code><code class="racket symbol">param-ctx</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">defined-ids</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
    
    </code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax-rule</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax/track</code><code class="racket"> </code><code class="racket symbol">form</code><code class="racket parenthesis">)</code><code class="racket">
      </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">this-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
        </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">head</code><code class="racket"> . </code><code class="racket symbol">_</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-track-origin</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">form</code><code class="racket"> </code><code class="racket symbol">this-syntax</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">head</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket">
   
   </code><code class="racket hash-colon-keyword">#:with</code><code class="racket"> </code><code class="racket symbol">ctor-body</code><code class="racket">
   </code><code class="racket parenthesis">(</code><code class="racket symbol">let</code><code class="racket"> </code><code class="racket symbol">loop</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">begin</code><code class="racket"> </code><code class="racket symbol">body</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-parse</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">expand</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket hash-colon-keyword">#:literals</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">begin</code><code class="racket"> </code><code class="racket symbol">define-values</code><code class="racket"> </code><code class="racket symbol">define-syntaxes</code><code class="racket parenthesis">)</code><code class="racket">
       </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">begin</code><code class="racket"> </code><code class="racket symbol">form</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket">
        </code><code class="racket hash-colon-keyword">#:with</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">expanded-form</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">stx-map</code><code class="racket"> </code><code class="racket symbol">loop</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">form</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
        </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax/track</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">begin</code><code class="racket"> </code><code class="racket symbol">expanded-form</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket">
       </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">define-values</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">ids</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">expr</code><code class="racket parenthesis">)</code><code class="racket">
        </code><code class="racket hash-colon-keyword">#:with</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">bd</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">stx-map</code><code class="racket"> </code><code class="racket symbol">syntax-local-identifier-as-binding</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">ids</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
        </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-bind-syntaxes</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-&gt;list</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">bd</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">#f</code><code class="racket"> </code><code class="racket symbol">body-ctx</code><code class="racket parenthesis">)</code><code class="racket">
        </code><code class="racket parenthesis">(</code><code class="racket symbol">set!</code><code class="racket"> </code><code class="racket symbol">defined-ids</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">append</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-&gt;list</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">bd</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">defined-ids</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
        </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax/track</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">define-values</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">bd</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">expr</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket">
       </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntaxes</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">ids</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">expr</code><code class="racket parenthesis">)</code><code class="racket">
        </code><code class="racket hash-colon-keyword">#:with</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">bd</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">stx-map</code><code class="racket"> </code><code class="racket symbol">syntax-local-identifier-as-binding</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">ids</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
        </code><code class="racket hash-colon-keyword">#:with</code><code class="racket"> </code><code class="racket symbol">rhs</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">local-transformer-expand</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">expr</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">expression</code><code class="racket"> </code><code class="racket symbol">null</code><code class="racket"> </code><code class="racket symbol">body-ctx</code><code class="racket parenthesis">)</code><code class="racket">
        </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-bind-syntaxes</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-&gt;list</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">bd</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">rhs</code><code class="racket"> </code><code class="racket symbol">body-ctx</code><code class="racket parenthesis">)</code><code class="racket">
        </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax/track</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntaxes</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">bd</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">rhs</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket">
       </code><code class="racket parenthesis">[</code><code class="racket symbol">form</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">form</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
   </code><code class="racket hash-colon-keyword">#:with</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">field</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">defined-ids</code><code class="racket">
   </code><code class="racket hash-colon-keyword">#:with</code><code class="racket"> </code><code class="racket symbol">ctor</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">format-id</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">name</code><code class="racket"> </code><code class="racket string">"make-~a"</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">name</code><code class="racket"> </code><code class="racket hash-colon-keyword">#:subs?</code><code class="racket"> </code><code class="racket constant">#t</code><code class="racket parenthesis">)</code><code class="racket">
   </code><code class="racket hash-colon-keyword">#:with</code><code class="racket"> </code><code class="racket symbol">args-scoped</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">internal-definition-context-introduce</code><code class="racket"> </code><code class="racket symbol">param-ctx</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">args</code><code class="racket parenthesis">)</code><code class="racket">
   </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">begin</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">struct</code><code class="racket"> </code><code class="racket symbol">name</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">field</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
            </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">ctor</code><code class="racket"> . </code><code class="racket symbol">args-scoped</code><code class="racket parenthesis">)</code><code class="racket">
              </code><code class="racket symbol">ctor-body</code><code class="racket">
              </code><code class="racket parenthesis">(</code><code class="racket symbol">name</code><code class="racket"> </code><code class="racket symbol">field</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code></pre></div>
   <p>注意到这里还添加了<span><code class="racket symbol">syntax/track</code></span>的定义，用来协助Check Syntax。相关会在<a href="draw-arrow.html">如何让DrRacket正确画出箭头</a>中介绍。</p>
   <p>使用示例：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket symbol">&gt;</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">begin</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">define-record</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">foo</code><code class="racket"> </code><code class="racket symbol">l</code><code class="racket parenthesis">)</code><code class="racket">
      </code><code class="racket parenthesis">(</code><code class="racket symbol">match-define</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">list</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">y</code><code class="racket"> </code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">z</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">l</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

    </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">make-foo</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">list</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket"> </code><code class="racket constant">2</code><code class="racket"> </code><code class="racket constant">3</code><code class="racket"> </code><code class="racket constant">4</code><code class="racket"> </code><code class="racket constant">5</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">list</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">foo-x</code><code class="racket"> </code><code class="racket symbol">f</code><code class="racket parenthesis">)</code><code class="racket">
          </code><code class="racket parenthesis">(</code><code class="racket symbol">foo-y</code><code class="racket"> </code><code class="racket symbol">f</code><code class="racket parenthesis">)</code><code class="racket">
          </code><code class="racket parenthesis">(</code><code class="racket symbol">foo-z</code><code class="racket"> </code><code class="racket symbol">f</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket constant">'</code><code class="racket parenthesis">(</code><code class="racket constant">1</code><code class="racket"> </code><code class="racket constant">3</code><code class="racket"> </code><code class="racket constant">5</code><code class="racket parenthesis">)</code></pre></div>
   <h2 id="其他事项">其他事项</h2>
   <ul>
    <li>目前相关API中没有 <em>outside-edge scope</em> 的处理，在未来可能会调整，见<a href="https://github.com/racket/racket/issues/3251">https://github.com/racket/racket/issues/3251</a>和<a href="scope.html">Scope和Binding</a>。</li></ul></div></body></html>