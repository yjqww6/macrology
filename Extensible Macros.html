
<html>
 <head>
  <title>可扩展的宏</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <style>body {
  max-width: 1200px;
  margin-left: auto;
  margin-right: auto;
  font-family: "Open Sans","Clear Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
  line-height: 1.6;
  color: rgb(51,51,51);
}
div#whole {
  margin: 10px;
}
h1,h2 {
  border-bottom: solid thin lightgray;
}
ol,ul {
  margin: 0.8em 0;
  padding-left: 30px;
}
div.outer {
  border: solid 1px rgb(243,244,246);
  border-radius: 3px;
  margin: 10px 0 10px 0;
}
pre {
  margin: 0;
  word-wrap: break-word;
  white-space: pre-wrap;
  background: rgb(246,248,250);
  border: solid 1px rgb(239,241,242);
  border-radius: 3px;
  line-height: 1.3;
}
code.racket {
  font-family: 'Fira-Mono', monospace;
}
code.parenthesis {
  color: rgb(132,60,36);
}
code.symbol {
  color: rgb(38, 38, 128);
}
code.hash-colon-keyword {
  color: rgb(132, 60, 36);
}
code.string,code.constant {
  color: rgb(41, 128, 38);
}
code.comment,code.sexp-comment {
  color: rgb(192, 116, 31);
}</style></head>
 <body>
  <div id="whole">
   <h1 id="可扩展的宏">可扩展的宏</h1>
   <p>（早期版本：<a href="https://zhuanlan.zhihu.com/p/35953489">https://zhuanlan.zhihu.com/p/35953489</a> <a href="https://zhuanlan.zhihu.com/p/36709037">https://zhuanlan.zhihu.com/p/36709037</a> )</p>
   <p>一些宏中会提供扩展机制，例如 <span><code class="racket symbol">require</code></span> 、<span><code class="racket symbol">provide</code></span> 、<span><code class="racket symbol">for</code></span> 、<span><code class="racket symbol">match</code></span> 以及 <span><code class="racket symbol">syntax-parse</code></span>。</p>
   <p>其特征是需要用户自行定义一个宏A，并把A的名字提供给这些宏。A的过程会被调用，结果会被用于下一步的操作。</p>
   <p>一个例子：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket
</code><code class="racket parenthesis">(</code><code class="racket symbol">define-match-expander</code><code class="racket"> </code><code class="racket symbol">succ</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">λ</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
      </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">?N</code><code class="racket parenthesis">)</code><code class="racket">
       </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">app</code><code class="racket"> </code><code class="racket symbol">sub1</code><code class="racket"> </code><code class="racket symbol">?N</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">match</code><code class="racket"> </code><code class="racket constant">5</code><code class="racket">
  </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">succ</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">succ</code><code class="racket"> </code><code class="racket symbol">N</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">N</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code></pre></div>
   <p>这里用户定义了<span><code class="racket symbol">succ</code></span>（为什么会用 <span><code class="racket symbol">define-match-expander</code></span> 而不是 <span><code class="racket symbol">define-syntax</code></span> 后面会说），对应的过程被<span><code class="racket symbol">match</code></span>调用，最后匹配模式变成了 <span><code class="racket parenthesis">(</code><code class="racket symbol">app</code><code class="racket"> </code><code class="racket symbol">sub1</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">app</code><code class="racket"> </code><code class="racket symbol">sub1</code><code class="racket"> </code><code class="racket symbol">N</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code></span> 。最终输出<span><code class="racket constant">3</code></span>。</p>
   <h2 id="天真的实现">天真的实现</h2>
   <p>因为宏绑定的过程可以用 <span><code class="racket symbol">syntax-local-value</code></span> 获得，所以按直觉写出来的代码一般类似：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket

</code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket parenthesis">(</code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">expander1</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">use-expander</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">in</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket parenthesis">(</code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-value</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">in</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">use-expander</code><code class="racket"> </code><code class="racket symbol">expander1</code><code class="racket"> </code><code class="racket symbol">car</code><code class="racket parenthesis">)</code></pre></div>
   <p>这里直接调用<span><code class="racket symbol">expander1</code></span>的过程，而不是将其用于宏展开，最后展开为 <span><code class="racket parenthesis">(</code><code class="racket symbol">car</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code></span> ，结果得到<span><code class="racket constant">1</code></span>。</p>
   <h3 id="毛病">毛病</h3>
   <p>Racket的宏是卫生的，不是同一次的宏展开引入的名字默认不会意外绑定到彼此。然而，上面的方案中，<span><code class="racket symbol">expander1</code></span>的调用仍处于<span><code class="racket symbol">use-expander</code></span>的展开中，因此<span><code class="racket symbol">expander1</code></span>引入的<span><code class="racket symbol">x</code></span>是有可能出问题的。</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket

</code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket parenthesis">(</code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">expander1</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">use-expander</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">in</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket constant">#`</code><code class="racket parenthesis">(</code><code class="racket symbol">let</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket parenthesis">(</code><code class="racket constant">2</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
         #,</code><code class="racket parenthesis">(</code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-value</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">in</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">use-expander</code><code class="racket"> </code><code class="racket symbol">expander1</code><code class="racket"> </code><code class="racket symbol">car</code><code class="racket parenthesis">)</code></pre></div>
   <p>这里<span><code class="racket symbol">x</code></span>绑定到了<span><code class="racket symbol">use-expander</code></span>局部引入的<span><code class="racket symbol">x</code></span>，最终运行得到<span><code class="racket constant">2</code></span>。</p>
   <h2 id="早期的解决方案">早期的解决方案</h2>
   <p>Racket社区早期的解决方案是手动模拟宏展开过程中的 <em>macro-introduction scopes</em> 的双重反转。至于Racket宏的卫生原理文档里早有论述，这里不多做说明，见：</p>
   <ul>
    <li><a href="https://www.cs.utah.edu/plt/scope-sets/">https://www.cs.utah.edu/plt/scope-sets/</a></li>
    <li><a href="https://docs.racket-lang.org/reference/syntax-model.html#%28part._transformer-model%29">https://docs.racket-lang.org/reference/syntax-model.html#%28part._transformer-model%29</a></li>
    <li><a href="https://www.youtube.com/watch?v=Or_yKiI3Ha4">https://www.youtube.com/watch?v=Or_yKiI3Ha4</a></li></ul>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket

</code><code class="racket parenthesis">(</code><code class="racket symbol">begin-for-syntax</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">apply-expander</code><code class="racket"> </code><code class="racket symbol">proc</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">introducer</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">make-syntax-introducer</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">intro-stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">introducer</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-introduce</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-introduce</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">introducer</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">proc</code><code class="racket"> </code><code class="racket symbol">intro-stx</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket parenthesis">(</code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">expander1</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">use-expander</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">in</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket constant">#`</code><code class="racket parenthesis">(</code><code class="racket symbol">let</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket parenthesis">(</code><code class="racket constant">2</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
         #,</code><code class="racket parenthesis">(</code><code class="racket symbol">apply-expander</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-value</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">in</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">use-expander</code><code class="racket"> </code><code class="racket symbol">expander1</code><code class="racket"> </code><code class="racket symbol">car</code><code class="racket parenthesis">)</code></pre></div>
   <p>这个方法的核心在于<span><code class="racket symbol">apply-expander</code></span>过程：</p>
   <ol>
    <li>输入的<span><code class="racket symbol">stx</code></span>首先被应用<span><code class="racket symbol">syntax-local-introduce</code></span>，模拟<span><code class="racket symbol">use-expander</code></span>的展开过程暂时结束，准备进入新一次的宏展开。</li>
    <li><span><code class="racket symbol">introducer</code></span>被应用，模拟进入了新一次的宏展开，引入新的 <em>macro-introduction scope</em> 。</li>
    <li><span><code class="racket symbol">proc</code></span>被应用，得到<span><code class="racket symbol">expander1</code></span>的结果。</li>
    <li><span><code class="racket symbol">introducer</code></span>再次被应用，模拟<span><code class="racket symbol">expander1</code></span>的展开结束，反转此次的 <em>macro-introduction scope</em> 。</li>
    <li><span><code class="racket symbol">syntax-local-introduce</code></span>再次被应用，回到<span><code class="racket symbol">use-expander</code></span>的展开过程中。</li></ol>
   <p>这样，<span><code class="racket symbol">use-expander</code></span>的<span><code class="racket symbol">x</code></span>被打上了唯一的 <em>macro-introduction scope</em> ，<span><code class="racket symbol">expander1</code></span>的<span><code class="racket symbol">x</code></span>不可能具有该 <em>scope</em> ，不会意外的绑定。</p>
   <p>值得注意的是，这里<span><code class="racket symbol">syntax-local-introduce</code></span>和<span><code class="racket symbol">introducer</code></span>都是必要的：</p>
   <ul>
    <li>缺少<span><code class="racket symbol">syntax-local-introduce</code></span>的话，<span><code class="racket symbol">expander1</code></span>的<span><code class="racket symbol">x</code></span>会带上<span><code class="racket symbol">use-expander</code></span>的 <em>macro-introduction scope</em> ，仍会绑定到<span><code class="racket symbol">use-expander</code></span>的<span><code class="racket symbol">x</code></span>。另一方面，缺少<span><code class="racket symbol">syntax-local-introduce</code></span>也会对<span><code class="racket symbol">disappeared-use</code></span>的处理造成麻烦，这里不展开描述。</li>
    <li>缺少<span><code class="racket symbol">introducer</code></span>的话，如果<span><code class="racket symbol">use-expander</code></span>不止能调用<span><code class="racket symbol">expander1</code></span>，还能调用更多的宏，例如<span><code class="racket symbol">expander2</code></span>，那么<span><code class="racket symbol">expander1</code></span>和<span><code class="racket symbol">expander2</code></span>的结果可能意外地互相绑定。另外如果<span><code class="racket symbol">expander1</code></span>引入定义，<span><code class="racket symbol">use-expander</code></span>引入使用的话，也可能会出问题。</li></ul>
   <h2 id="插曲local-apply-transformer">插曲：local-apply-transformer</h2>
   <p>在7.0版本（准确来说，6.90.0.29）中，Racket正式引入了<span><code class="racket symbol">local-apply-transformer</code></span>这个api，它解决了什么问题呢？</p>
   <p>如果上面的<span><code class="racket symbol">expander1</code></span>也想要自己支持扩展功能，它能复用<span><code class="racket symbol">apply-expander</code></span>过程吗？不能，因为<span><code class="racket symbol">syntax-local-introduce</code></span>是属于<span><code class="racket symbol">use-expander</code></span>的，<span><code class="racket symbol">introduer</code></span>才是<span><code class="racket symbol">expander1</code></span>自己的"syntax-local-introduce"。注意到上面的<span><code class="racket symbol">introducer</code></span>是<span><code class="racket symbol">apply-expander</code></span>的一个局部变量，这样<span><code class="racket symbol">expander1</code></span>甚至无法访问到自己的<span><code class="racket symbol">introducer</code></span>，自然也不能用来写 扩展了。</p>
   <p>传统的解法是把<span><code class="racket symbol">introducer</code></span>绑定到一个parameter里面，这样<span><code class="racket symbol">expander1</code></span>就可以访问它了。这就是为什么会有 <span><code class="racket symbol">syntax-local-match-introduce</code></span> , <span><code class="racket symbol">syntax-local-require-introduce</code></span> , <span><code class="racket symbol">syntax-local-provide-introduce</code></span> , <span><code class="racket symbol">syntax-local-syntax-parse-pattern-introduce</code></span> , ……</p>
   <p>但是这样<span><code class="racket symbol">expander1</code></span>怎么知道以自己的身份到底该用哪个“introducer”呢？也许大家再共用一个“current-introduce”？这样就太容易遗漏了。</p>
   <p>对于这个问题，<span><code class="racket symbol">local-apply-transformer</code></span>的方案是不直接调用<span><code class="racket symbol">expander1</code></span>的过程，而是通过<span><code class="racket symbol">local-expand</code></span>将其作为一次宏展开间接地调用。这样，<span><code class="racket symbol">expander1</code></span>就是一次普通的宏展开了，对应的<span><code class="racket symbol">introducer</code></span>就是普通的“syntax-local-introduce”，上面那堆“xxx-introduce”也就不需要了。</p>
   <p>因此，上面的写法演变为</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket
</code><code class="racket parenthesis">(</code><code class="racket symbol">require</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">for-syntax</code><code class="racket"> </code><code class="racket symbol">syntax/apply-transformer</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">begin-for-syntax</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">apply-expander</code><code class="racket"> </code><code class="racket symbol">proc</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">local-apply-transformer</code><code class="racket"> </code><code class="racket symbol">proc</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">expression</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket parenthesis">(</code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">expander1</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">use-expander</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">in</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket constant">#`</code><code class="racket parenthesis">(</code><code class="racket symbol">let</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket parenthesis">(</code><code class="racket constant">2</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
         #,</code><code class="racket parenthesis">(</code><code class="racket symbol">apply-expander</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-value</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">in</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">use-expander</code><code class="racket"> </code><code class="racket symbol">expander1</code><code class="racket"> </code><code class="racket symbol">car</code><code class="racket parenthesis">)</code></pre></div>
   <h2 id="还有问题">还有问题？</h2>
   <p>回到早期方案，来看看这个程序：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket
</code><code class="racket parenthesis">(</code><code class="racket symbol">begin-for-syntax</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">apply-expander</code><code class="racket"> </code><code class="racket symbol">proc</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">introducer</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">make-syntax-introducer</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">intro-stx</code><code class="racket">  </code><code class="racket parenthesis">(</code><code class="racket symbol">introducer</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-introduce</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-introduce</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">introducer</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">proc</code><code class="racket"> </code><code class="racket symbol">intro-stx</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket parenthesis">(</code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">expander1</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">an-x</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">let</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">an-x</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket parenthesis">(</code><code class="racket constant">3</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
                   </code><code class="racket parenthesis">(</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">use-expander</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">an-x</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">in</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket constant">#`</code><code class="racket parenthesis">(</code><code class="racket symbol">let</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket parenthesis">(</code><code class="racket constant">2</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
         #,</code><code class="racket parenthesis">(</code><code class="racket symbol">apply-expander</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-value</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">an-x</code><code class="racket"> </code><code class="racket symbol">in</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">use-expander</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket symbol">expander1</code><code class="racket"> </code><code class="racket symbol">car</code><code class="racket parenthesis">)</code></pre></div>
   <p>得到了<span><code class="racket constant">3</code></span>，为什么呢？</p>
   <p>简单来说，在<span><code class="racket symbol">apply-expander</code></span>时，因为<span><code class="racket symbol">use-expander</code></span>的定义和使用在同一 <em>definition context</em> ，<span><code class="racket symbol">syntax-local-introduce</code></span>反转的不仅有 <em>macro-introduction scope</em> ，还有 <em>use-site scope</em> ，因此<span><code class="racket symbol">expander1</code></span>中的<span><code class="racket symbol">x</code></span>被打上了 <em>use-site scope</em> ，然后 <em>use-site scope</em> 在宏展开结束时不会被反转。<span><code class="racket symbol">an-x</code></span>和<span><code class="racket symbol">x</code></span>都带有该 <em>scope</em> ，导致返回<span><code class="racket constant">3</code></span>。</p>
   <p>但是对一个卫生的宏系统，这里应该得到<span><code class="racket constant">1</code></span>，就像直接调用 <span><code class="racket parenthesis">(</code><code class="racket symbol">expand1</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket symbol">car</code><code class="racket parenthesis">)</code></span> 那样。</p>
   <p>我们无法直接模拟 <em>use-site scope</em> （缺少一个检测宏的定义和使用是否在同一 <em>definition context</em> 的api），所以直接在早期方案上改进似乎无法解决这个问题。（注：一些失败的尝试可在<a href="https://zhuanlan.zhihu.com/p/36709037">https://zhuanlan.zhihu.com/p/36709037</a>看到）</p>
   <h2 id="local-apply-transformer可以解决问题吗">local-apply-transformer可以解决问题吗？</h2>
   <p>将上面的<span><code class="racket symbol">apply-expander</code></span>定义替换，得到（记为程序A）</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket
</code><code class="racket parenthesis">(</code><code class="racket symbol">require</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">for-syntax</code><code class="racket"> </code><code class="racket symbol">syntax/apply-transformer</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">begin-for-syntax</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">apply-expander</code><code class="racket"> </code><code class="racket symbol">proc</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">local-apply-transformer</code><code class="racket"> </code><code class="racket symbol">proc</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">expression</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">use-expander</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">an-x</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">in</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket constant">#`</code><code class="racket parenthesis">(</code><code class="racket symbol">let</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket parenthesis">(</code><code class="racket constant">2</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
         #,</code><code class="racket parenthesis">(</code><code class="racket symbol">apply-expander</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-value</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">an-x</code><code class="racket"> </code><code class="racket symbol">in</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
  
</code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket parenthesis">(</code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">expander1</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">an-x</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">let</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">an-x</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket parenthesis">(</code><code class="racket constant">3</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
                   </code><code class="racket parenthesis">(</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">use-expander</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket symbol">expander1</code><code class="racket"> </code><code class="racket symbol">car</code><code class="racket parenthesis">)</code></pre></div>
   <p>这次是<span><code class="racket constant">1</code></span>了，那么问题解决了吗？</p>
   <p>并没有，把<span><code class="racket symbol">expander1</code></span>的定义和使用套进<span><code class="racket symbol">let</code></span>里（记为程序B），仍得到3</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket
</code><code class="racket parenthesis">(</code><code class="racket symbol">require</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">for-syntax</code><code class="racket"> </code><code class="racket symbol">syntax/apply-transformer</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">begin-for-syntax</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">apply-expander</code><code class="racket"> </code><code class="racket symbol">proc</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">local-apply-transformer</code><code class="racket"> </code><code class="racket symbol">proc</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">expression</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">use-expander</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">an-x</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">in</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket constant">#`</code><code class="racket parenthesis">(</code><code class="racket symbol">let</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket parenthesis">(</code><code class="racket constant">2</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
         #,</code><code class="racket parenthesis">(</code><code class="racket symbol">apply-expander</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-value</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">an-x</code><code class="racket"> </code><code class="racket symbol">in</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
  
</code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket parenthesis">(</code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">let</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">expander1</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
      </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">an-x</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">let</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">an-x</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket parenthesis">(</code><code class="racket constant">3</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
                     </code><code class="racket parenthesis">(</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

  </code><code class="racket parenthesis">(</code><code class="racket symbol">use-expander</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket symbol">expander1</code><code class="racket"> </code><code class="racket symbol">car</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code></pre></div>
   <p>为什么在A里是<span><code class="racket constant">1</code></span>？因为用<span><code class="racket symbol">local-apply-transformer</code></span>的话，结果的 <em>use-site scope</em> 就跟普通的宏展开一样，不会被反转。这样，<span><code class="racket symbol">expander1</code></span>里<span><code class="racket parenthesis">(</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code></span>的<span><code class="racket symbol">x</code></span>没有 <em>use-site scope</em> 。这就是它跟早期方案的不同。</p>
   <p>那为什么在B里又变回<span><code class="racket constant">3</code></span>了？因为<span><code class="racket symbol">use-expander</code></span>的定义和使用不在同一 <em>definition context</em> 了，所以也就都没有 <em>use-site scope</em> 了。</p>
   <p>可以认为上面对<span><code class="racket symbol">local-apply-transformer</code></span>的使用效果类似于</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket parenthesis">(</code><code class="racket symbol">begin-for-syntax</code><code class="racket">
  </code><code class="racket comment">;;只反转macro-introduction scope</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">macro-scope-introducer</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">make-syntax-delta-introducer</code><code class="racket">
     </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-identifier-as-binding</code><code class="racket">
      </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-introduce</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket constant">#'</code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">apply-expander</code><code class="racket"> </code><code class="racket symbol">proc</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">macro-introducer</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">macro-scope-introducer</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">introducer</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">make-syntax-introducer</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">intro-stx</code><code class="racket">  </code><code class="racket parenthesis">(</code><code class="racket symbol">introducer</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">macro-introducer</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">macro-introducer</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">introducer</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">proc</code><code class="racket"> </code><code class="racket symbol">intro-stx</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code></pre></div>
   <p>实际上，在此文写下的时间点，Racket标准库里也有这个问题：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket
</code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket symbol">sub1</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">define-match-expander</code><code class="racket"> </code><code class="racket symbol">succ</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">lambda</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
      </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">v</code><code class="racket parenthesis">)</code><code class="racket">  </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">app</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">let</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">v</code><code class="racket"> </code><code class="racket symbol">add1</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">v</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">match</code><code class="racket"> </code><code class="racket constant">3</code><code class="racket">
  </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">succ</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket comment">;得到4，而不是2</code></pre></div>
   <h3 id="到底错在哪里">到底错在哪里？</h3>
   <p>仔细观察会发现，<span><code class="racket symbol">use-expander</code></span>的 <em>use-site scope</em> 并不完全是问题所在。</p>
   <p>不妨先看看普通宏版本是什么情况：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">use-expander</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">an-x</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">in</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">let</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket parenthesis">(</code><code class="racket constant">2</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
         </code><code class="racket parenthesis">(</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">an-x</code><code class="racket"> </code><code class="racket symbol">in</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
  
</code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket parenthesis">(</code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">let</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">expander1</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
      </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">an-x</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">let</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">an-x</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket parenthesis">(</code><code class="racket constant">3</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
                       </code><code class="racket parenthesis">(</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

  </code><code class="racket parenthesis">(</code><code class="racket symbol">use-expander</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket symbol">expander1</code><code class="racket"> </code><code class="racket symbol">car</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code></pre></div>
   <p>这里<span><code class="racket symbol">use-expander</code></span>先被展开，因此 <span><code class="racket parenthesis">(</code><code class="racket symbol">let</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket parenthesis">(</code><code class="racket constant">2</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code></span> 这里带有了<span><code class="racket symbol">let</code></span>自己的local <em>scope</em> 。同时，因为<span><code class="racket parenthesis">(</code><code class="racket symbol">let</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">an-x</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket parenthesis">(</code><code class="racket constant">3</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code></span> 这里的<span><code class="racket symbol">an-x</code></span>是<span><code class="racket symbol">use-expander</code></span>传来的，这样两个局部的<span><code class="racket symbol">x</code></span>都带有该local <em>scope</em> 。然而，<span><code class="racket parenthesis">(</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code></span>的<span><code class="racket symbol">x</code></span>是<span><code class="racket symbol">expander1</code></span>新引入的，没有该local <em>scope</em> ，所以只能绑定到module顶部的<span><code class="racket symbol">x</code></span>。</p>
   <p>另一方面，如果不要<span><code class="racket symbol">use-expander</code></span>内部的<span><code class="racket symbol">let</code></span>：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">use-expander</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">an-x</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">in</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">an-x</code><code class="racket"> </code><code class="racket symbol">in</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
  
</code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket parenthesis">(</code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">let</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">expander1</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
      </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">an-x</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">let</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">an-x</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket parenthesis">(</code><code class="racket constant">3</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
                       </code><code class="racket parenthesis">(</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

  </code><code class="racket parenthesis">(</code><code class="racket symbol">use-expander</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket symbol">expander1</code><code class="racket"> </code><code class="racket symbol">car</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code></pre></div>
   <p>这里则是<span><code class="racket symbol">expander1</code></span>自身定义和使用在同一 <em>definition context</em> ，<span><code class="racket symbol">an-x</code></span>带有 <em>use-site scope</em> ，因此也能得到<span><code class="racket constant">1</code></span>。</p>
   <p>所以真正的问题有两个：</p>
   <ol>
    <li>内部的<span><code class="racket symbol">expander1</code></span>先于外部的<span><code class="racket symbol">use-expander</code></span>被展开，以至内部被打上了本不该有的local <em>scope</em>。</li>
    <li><span><code class="racket symbol">expander1</code></span>的展开没有适当地引入 <em>use-site scope</em> 。事实上，在 <em>expression context</em> 下，<span><code class="racket symbol">local-apply-transformer</code></span>（或者说<span><code class="racket symbol">local-expand</code></span>）永远不会引入 <em>use-site scope</em> ，这是与Racket 7之前的expander的一个差异。</li></ol>
   <p>这两个问题归根到底都是<span><code class="racket symbol">local-expand</code></span>的问题，似乎可能通过把宏写成“trampoline”的形式回避，但相信没人会愿意这么写吧。</p>
   <h3 id="如果添加use-site-scope">如果添加use-site scope</h3>
   <p>另一方面，如果把<span><code class="racket symbol">local-apply-transformer</code></span>从 <em>expression context</em> 换到 <em>internal definition context</em> ，则会无条件引入 <em>use-site scope</em> 。</p>
   <p>这么修改，A和B都能得到<span><code class="racket constant">1</code></span>。</p>
   <p>可以认为效果类似于</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket parenthesis">(</code><code class="racket symbol">begin-for-syntax</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">macro-scope-introducer</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">make-syntax-delta-introducer</code><code class="racket">
     </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-identifier-as-binding</code><code class="racket">
      </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-introduce</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket constant">#'</code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">apply-expander</code><code class="racket"> </code><code class="racket symbol">proc</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">macro-introducer</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">macro-scope-introducer</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">introducer</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">make-syntax-introducer</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">use-site-introducer</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">make-syntax-introducer</code><code class="racket"> </code><code class="racket constant">#t</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">intro-stx</code><code class="racket">  </code><code class="racket parenthesis">(</code><code class="racket symbol">use-site-introducer</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">introducer</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">macro-introducer</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">macro-introducer</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">introducer</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">proc</code><code class="racket"> </code><code class="racket symbol">intro-stx</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code></pre></div>
   <p>但这并不意味着完全对了。在可扩展的宏中，模式匹配一类，也即是需要引入绑定的，的是最常见的。</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket
</code><code class="racket parenthesis">(</code><code class="racket symbol">require</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">for-syntax</code><code class="racket"> </code><code class="racket symbol">syntax/apply-transformer</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">begin-for-syntax</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">apply-expander</code><code class="racket"> </code><code class="racket symbol">proc</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">local-apply-transformer</code><code class="racket"> </code><code class="racket symbol">proc</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">list</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">gensym</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket parenthesis">(</code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">use-expander</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">an-x</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">in</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket constant">#`</code><code class="racket parenthesis">(</code><code class="racket symbol">let-values</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket">#,</code><code class="racket parenthesis">(</code><code class="racket symbol">apply-expander</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-value</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">an-x</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
         </code><code class="racket symbol">in</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">expander1</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket symbol">an-x</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">an-x</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket parenthesis">(</code><code class="racket constant">2</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">use-expander</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket symbol">expander1</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">car</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code></pre></div>
   <p>这里还是得到<span><code class="racket constant">1</code></span>，但是期望应该是<span><code class="racket constant">2</code></span>。</p>
   <p>因为在绑定的位置引入了 <em>use-site scope</em> ，导致<span><code class="racket symbol">expander1</code></span>的x没能绑定到<span><code class="racket parenthesis">(</code><code class="racket symbol">car</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code></span>中的x。</p>
   <p><span><code class="racket symbol">syntax-local-identifier-as-binding</code></span>可以消除 <em>use-site scope</em> ，所以如果事先知道结果的形状，还是有可能解决问题的：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket
</code><code class="racket parenthesis">(</code><code class="racket symbol">require</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">for-syntax</code><code class="racket"> </code><code class="racket symbol">syntax/apply-transformer</code><code class="racket"> </code><code class="racket symbol">syntax/stx</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">begin-for-syntax</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">apply-expander</code><code class="racket"> </code><code class="racket symbol">proc</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">local-apply-transformer</code><code class="racket"> </code><code class="racket symbol">proc</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">list</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">gensym</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket parenthesis">(</code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">use-expander</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">an-x</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">in</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket constant">#`</code><code class="racket parenthesis">(</code><code class="racket symbol">let-values</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket">#,</code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">apply-expander</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-value</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">an-x</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
                        </code><code class="racket parenthesis">[</code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">rhs</code><code class="racket parenthesis">]</code><code class="racket">
                         </code><code class="racket parenthesis">(</code><code class="racket symbol">with-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket">
                                        </code><code class="racket parenthesis">(</code><code class="racket symbol">stx-map</code><code class="racket"> </code><code class="racket symbol">syntax-local-identifier-as-binding</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
                           </code><code class="racket constant">#'</code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">rhs</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
         </code><code class="racket symbol">in</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">expander1</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket symbol">an-x</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">an-x</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket parenthesis">(</code><code class="racket constant">2</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">use-expander</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket symbol">expander1</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">car</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code></pre></div>
   <p>这个方案其实就是 <a href="https://github.com/racket/racket/pull/2237">https://github.com/racket/racket/pull/2237</a> 。</p>
   <p>但是，对于不可预测的展开，情况就比较复杂了。考虑可以引入定义的展开（例如<span><code class="racket symbol">syntax-parse</code></span>的<span><code class="racket symbol">~do</code></span>）：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket
</code><code class="racket parenthesis">(</code><code class="racket symbol">require</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">for-syntax</code><code class="racket"> </code><code class="racket symbol">syntax/apply-transformer</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">begin-for-syntax</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">apply-expander</code><code class="racket"> </code><code class="racket symbol">proc</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">local-apply-transformer</code><code class="racket"> </code><code class="racket symbol">proc</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">list</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">gensym</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">use-expander</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket parenthesis">[</code><code class="racket symbol">defs</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">]</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">in</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket constant">#`</code><code class="racket parenthesis">(</code><code class="racket symbol">let</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">2</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
         #,</code><code class="racket parenthesis">(</code><code class="racket symbol">apply-expander</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-value</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">defs</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
         </code><code class="racket symbol">in</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">expander1</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">defs</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">begin</code><code class="racket"> </code><code class="racket symbol">defs</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">use-expander</code><code class="racket"> </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">3</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket"> </code><code class="racket symbol">expander1</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code></pre></div>
   <p>这里结果是<span><code class="racket constant">1</code></span>，但期望应该是<span><code class="racket constant">3</code></span>。一种修复方法是再使用部分展开</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket
</code><code class="racket parenthesis">(</code><code class="racket symbol">require</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">for-syntax</code><code class="racket"> </code><code class="racket symbol">syntax/apply-transformer</code><code class="racket">
                     </code><code class="racket symbol">syntax/kerncase</code><code class="racket"> </code><code class="racket symbol">syntax/stx</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">begin-for-syntax</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">apply-expander</code><code class="racket"> </code><code class="racket symbol">proc</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">local-apply-transformer</code><code class="racket"> </code><code class="racket symbol">proc</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">list</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">gensym</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

  </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">remove-binder-use-site</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">ctx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-make-definition-context</code><code class="racket"> </code><code class="racket constant">#f</code><code class="racket"> </code><code class="racket constant">#f</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">c</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">list</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">gensym</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">expand</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
      </code><code class="racket parenthesis">(</code><code class="racket symbol">local-expand</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket symbol">c</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">kernel-form-identifier-list</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">ctx</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">let</code><code class="racket"> </code><code class="racket symbol">loop</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">expand</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
      </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">define-values</code><code class="racket"> </code><code class="racket symbol">define-syntaxes</code><code class="racket"> </code><code class="racket symbol">begin</code><code class="racket parenthesis">)</code><code class="racket">
        </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">begin</code><code class="racket"> </code><code class="racket symbol">form</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket">
         </code><code class="racket parenthesis">(</code><code class="racket symbol">with-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">form</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">stx-map</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">compose</code><code class="racket"> </code><code class="racket symbol">loop</code><code class="racket"> </code><code class="racket symbol">expand</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">form</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
           </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">begin</code><code class="racket"> </code><code class="racket symbol">form</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket">
        </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">define-values</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">expr</code><code class="racket parenthesis">)</code><code class="racket">
         </code><code class="racket parenthesis">(</code><code class="racket symbol">begin</code><code class="racket">
           </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-bind-syntaxes</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-&gt;list</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">#f</code><code class="racket"> </code><code class="racket symbol">ctx</code><code class="racket parenthesis">)</code><code class="racket">
           </code><code class="racket parenthesis">(</code><code class="racket symbol">with-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">stx-map</code><code class="racket"> </code><code class="racket symbol">syntax-local-identifier-as-binding</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
             </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">define-values</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">expr</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket">
        </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntaxes</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">expr</code><code class="racket parenthesis">)</code><code class="racket">
         </code><code class="racket parenthesis">(</code><code class="racket symbol">with-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">expr</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">local-transformer-expand</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">expr</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">expression</code><code class="racket"> </code><code class="racket symbol">null</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
           </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-bind-syntaxes</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-&gt;list</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">expr</code><code class="racket"> </code><code class="racket symbol">ctx</code><code class="racket parenthesis">)</code><code class="racket">
           </code><code class="racket parenthesis">(</code><code class="racket symbol">with-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">stx-map</code><code class="racket"> </code><code class="racket symbol">syntax-local-identifier-as-binding</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
             </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntaxes</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket symbol">expr</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket">
        </code><code class="racket parenthesis">[</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">use-expander</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket parenthesis">[</code><code class="racket symbol">defs</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">]</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">in</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket constant">#`</code><code class="racket parenthesis">(</code><code class="racket symbol">let</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">2</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
         #,</code><code class="racket parenthesis">(</code><code class="racket symbol">remove-binder-use-site</code><code class="racket">
            </code><code class="racket parenthesis">(</code><code class="racket symbol">apply-expander</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-value</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">defs</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
         </code><code class="racket symbol">in</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">expander1</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">defs</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">begin</code><code class="racket"> </code><code class="racket symbol">defs</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">use-expander</code><code class="racket"> </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">3</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket"> </code><code class="racket symbol">expander1</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code></pre></div>
   <p>这种方法需要仔细区分各种expander预期的上下文。</p>
   <h2 id="结论">结论</h2>
   <p>对于这个问题，现在仍没有完美的解决方案。</p>
   <ul>
    <li>如果不需要引入绑定， <span><code class="racket parenthesis">(</code><code class="racket symbol">local-apply-transformer</code><code class="racket"> </code><code class="racket symbol">proc</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">list</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">gensym</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code></span> 比较合适。</li>
    <li>如果需要引入绑定，
     <ul>
      <li>可以接受一些风险，可以使用 <span><code class="racket parenthesis">(</code><code class="racket symbol">local-apply-transformer</code><code class="racket"> </code><code class="racket symbol">proc</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">expression</code><code class="racket parenthesis">)</code></span> ；</li>
      <li>如果能忍受一些麻烦，可以用 <span><code class="racket parenthesis">(</code><code class="racket symbol">local-apply-transformer</code><code class="racket"> </code><code class="racket symbol">proc</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">list</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">gensym</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code></span> 配合<span><code class="racket symbol">syntax-local-identifier-as-binding</code></span>。</li></ul></li></ul>
   <h2 id="其他相关问题">其他相关问题</h2>
   <h3 id="不要使用syntax-rules">不要使用syntax-rules</h3>
   <p>编写<span><code class="racket symbol">expander1</code></span>的时候，注意不要使用<span><code class="racket symbol">syntax-rules</code></span>，因为其会对结果应用<span><code class="racket symbol">syntax-protect</code></span>。而一般写<span><code class="racket symbol">use-expander</code></span>这类宏的时候，是不会特意去<span><code class="racket symbol">syntax-disarm</code></span>的，因此结果会处于 <em>tainted</em> 状态。</p>
   <h3 id="define-vs-attach">define vs attach</h3>
   <p>见<a href="https://rmculpepper.github.io/blog/2013/06/define-vs-attach/">https://rmculpepper.github.io/blog/2013/06/define-vs-attach/</a></p>
   <h3 id="为什么需要define-match-expander">为什么需要define-match-expander</h3>
   <p>因为会需要定义的名字在<span><code class="racket symbol">match</code></span>内外有不同的行为。例如，在<span><code class="racket symbol">match</code></span>外面使用时，直接报错。</p>
   <p>因此需要把match-expander定义成一个struct，并利用 <em>struct property</em> 控制其行为。<span><code class="racket symbol">prop:procedure</code></span>对应在外面使用的情况，<span><code class="racket symbol">prop:match-expander</code></span>对应<span><code class="racket symbol">match</code></span>内使用的情况。</p>
   <p>那么为什么需要<span><code class="racket symbol">prop:match-expander</code></span>，而不是固定使用某一字段呢？</p>
   <p>因为struct可以有多个 <em>struct property</em> ，可以同时带有<span><code class="racket symbol">prop:pattern-expander</code></span>等其他的，做到一个名字在不同宏里有不同意义。如果简单限定为一个字段，嵌套后会失去其他属性。</p></div></body></html>