
<html>
 <head>
  <title>如何设置编译期信息</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <style>body {
  max-width: 1200px;
  margin-left: auto;
  margin-right: auto;
  font-family: "Open Sans","Clear Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
  line-height: 1.6;
  color: rgb(51,51,51);
}
div#whole {
  margin: 10px;
}
h1,h2 {
  border-bottom: solid thin lightgray;
}
ol,ul {
  margin: 0.8em 0;
  padding-left: 30px;
}
div.outer {
  border: solid 1px rgb(243,244,246);
  border-radius: 3px;
  margin: 10px 0 10px 0;
}
pre {
  margin: 0;
  word-wrap: break-word;
  white-space: pre-wrap;
  background: rgb(246,248,250);
  border: solid 1px rgb(239,241,242);
  border-radius: 3px;
  line-height: 1.3;
}
code.racket {
  font-family: 'Fira-Mono', monospace;
}
code.parenthesis {
  color: rgb(132,60,36);
}
code.symbol {
  color: rgb(38, 38, 128);
}
code.hash-colon-keyword {
  color: rgb(132, 60, 36);
}
code.string,code.constant {
  color: rgb(41, 128, 38);
}
code.comment,code.sexp-comment {
  color: rgb(192, 116, 31);
}</style></head>
 <body>
  <div id="whole">
   <h1 id="如何设置编译期信息">如何设置编译期信息</h1>
   <p>在Racket中，设置编译期信息，并可以被宏利用的手段，主要分为几类：</p>
   <ul>
    <li>编译期的副作用</li>
    <li>Transformer Binding</li>
    <li>Syntax Property</li></ul>
   <h2 id="副作用">副作用</h2>
   <p>在编译期使用带有副作用的代码是最灵活的手段，例如统计一个宏调用的次数：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-for-syntax</code><code class="racket"> </code><code class="racket symbol">a-counter</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">box</code><code class="racket"> </code><code class="racket constant">0</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">a</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">expr</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket parenthesis">(</code><code class="racket symbol">begin</code><code class="racket">
       </code><code class="racket parenthesis">(</code><code class="racket symbol">set-box!</code><code class="racket"> </code><code class="racket symbol">a-counter</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">add1</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">unbox</code><code class="racket"> </code><code class="racket symbol">a-counter</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
       </code><code class="racket constant">#'</code><code class="racket symbol">expr</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">report-a</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">datum-&gt;syntax</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">unbox</code><code class="racket"> </code><code class="racket symbol">a-counter</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">a</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket comment">;1</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">a</code><code class="racket"> </code><code class="racket constant">2</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket comment">;2</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">report-a</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket comment">;2</code></pre></div>
   <p>只要在phase 1的代码里添加副作用，后续的宏就能看到该副作用，这样就设置了编译期的信息。</p>
   <p>但是，这里需要注意几个问题：</p>
   <h3 id="the-separate-compilation-guarantee">The Separate Compilation Guarantee</h3>
   <p>在DrRacket里运行上述代码后，在repl中输入<span><code class="racket parenthesis">(</code><code class="racket symbol">report-a</code><code class="racket parenthesis">)</code></span>：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket symbol">&gt;</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">report-a</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket constant">0</code></pre></div>
   <p>这时因为每次一个module编译时，其phase 1的实例都是新创建的，其在phase 1引用的module也是如此。程序展开时的<span><code class="racket symbol">a-counter</code></span>，和repl或者submodule展开时的<span><code class="racket symbol">a-counter</code></span>，已经不是同一个了。这个是Racket的“The Separate Compilation Guarantee”，目的是为了各个module独立编译的一致性。</p>
   <p>上面的实现中，<span><code class="racket symbol">a</code></span>展开后，虽然产生了修改<span><code class="racket symbol">a-counter</code></span>的副作用，但这个副作用并没有留到展开后的程序里。</p>
   <p>解决这个问题的思路是并非直接在宏里执行副作用代码，而是让副作用的代码保留在宏展开后的结果里，作为module的phase 1初始化的一部分。这样module被其他地方使用的时候都能重新执行一遍，得到等价的结果。</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-for-syntax</code><code class="racket"> </code><code class="racket symbol">a-counter</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">box</code><code class="racket"> </code><code class="racket constant">0</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">a</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">expr</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">begin</code><code class="racket">
         </code><code class="racket parenthesis">(</code><code class="racket symbol">begin-for-syntax</code><code class="racket">
           </code><code class="racket parenthesis">(</code><code class="racket symbol">set-box!</code><code class="racket"> </code><code class="racket symbol">a-counter</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">add1</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">unbox</code><code class="racket"> </code><code class="racket symbol">a-counter</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
         </code><code class="racket symbol">expr</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">report-a</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">datum-&gt;syntax</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">unbox</code><code class="racket"> </code><code class="racket symbol">a-counter</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">a</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">a</code><code class="racket"> </code><code class="racket constant">2</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">report-a</code><code class="racket parenthesis">)</code></pre></div>
   <p>注意到<span><code class="racket symbol">begin-for-syntax</code></span>只能在module level或者top-level使用，如果要在 <em>internal definition context</em> 使用，可以改成</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">a</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">expr</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">begin</code><code class="racket">
         </code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntaxes</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
           </code><code class="racket parenthesis">(</code><code class="racket symbol">begin</code><code class="racket">
             </code><code class="racket parenthesis">(</code><code class="racket symbol">set-box!</code><code class="racket"> </code><code class="racket symbol">a-counter</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">add1</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">unbox</code><code class="racket"> </code><code class="racket symbol">a-counter</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
             </code><code class="racket parenthesis">(</code><code class="racket symbol">values</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
         </code><code class="racket symbol">expr</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code></pre></div>
   <h3 id="generative和3d-syntax">Generative和3D Syntax</h3>
   <p>通过展开为phase 1的代码达成副作用时，有时可能直接把某种struct放入生成的Syntax Object里：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket

</code><code class="racket parenthesis">(</code><code class="racket symbol">begin-for-syntax</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">struct</code><code class="racket"> </code><code class="racket symbol">A</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">v</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-for-syntax</code><code class="racket"> </code><code class="racket symbol">a</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">box</code><code class="racket"> </code><code class="racket constant">#f</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">set-a!</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">v</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket parenthesis">(</code><code class="racket symbol">begin</code><code class="racket">
       </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">A</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-&gt;datum</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">v</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
       </code><code class="racket constant">#`</code><code class="racket parenthesis">(</code><code class="racket symbol">begin-for-syntax</code><code class="racket">
           </code><code class="racket parenthesis">(</code><code class="racket symbol">set-box!</code><code class="racket"> </code><code class="racket symbol">a</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket">#,</code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">get-a</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket constant">#`</code><code class="racket constant">'</code><code class="racket">#,</code><code class="racket parenthesis">(</code><code class="racket symbol">A-v</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">unbox</code><code class="racket"> </code><code class="racket symbol">a</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">set-a!</code><code class="racket"> </code><code class="racket constant">10</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">get-a</code><code class="racket parenthesis">)</code></pre></div>
   <p>同样，在DrRacket中运行，显示<span><code class="racket constant">10</code></span>；然后到repl里：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket symbol">&gt;</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">get-a</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket symbol">A-v:</code><code class="racket"> </code><code class="racket symbol">contract</code><code class="racket"> </code><code class="racket symbol">violation</code><code class="racket">
  </code><code class="racket symbol">expected:</code><code class="racket"> </code><code class="racket symbol">A?</code><code class="racket">
  </code><code class="racket symbol">given:</code><code class="racket"> #&lt;A&gt;</code></pre></div>
   <p>这是因为<span><code class="racket symbol">struct</code></span>是“generative”的，每次运行都产生了新的定义，repl中的<span><code class="racket symbol">A</code></span>和原来module展开时的<span><code class="racket symbol">A</code></span>，已经不是同一种结构了。</p>
   <p>使用<span><code class="racket parenthesis">(</code><code class="racket symbol">struct</code><code class="racket"> </code><code class="racket symbol">A</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">v</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket hash-colon-keyword">#:prefab</code><code class="racket parenthesis">)</code></span>可以回避这个问题，但仍是治标不治本，因为所用结构的定义不一定都是受自己控制的。</p>
   <p>正确的做法是不直接在代码中放入所需的数据结构，而是展开为构造这个结构的代码：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">set-a!</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">v</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">begin-for-syntax</code><code class="racket">
         </code><code class="racket parenthesis">(</code><code class="racket symbol">set-box!</code><code class="racket"> </code><code class="racket symbol">a</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">A</code><code class="racket"> </code><code class="racket symbol">v</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">get-a</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket parenthesis">(</code><code class="racket symbol">datum-&gt;syntax</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">A-v</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">unbox</code><code class="racket"> </code><code class="racket symbol">a</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code></pre></div>
   <p>这样，phase 1的代码构造的<span><code class="racket symbol">A</code></span>就是当前可见的<span><code class="racket symbol">A</code></span>。</p>
   <p>实际上，在Syntax Object里放入无法marshal的值，得到的是一个 <em>3D Syntax</em> ，无法序列化或编译到文件。修改前的<span><code class="racket symbol">A</code></span>就是一个例子。</p>
   <p>Typed Racket中的<span><code class="racket symbol">Syntax</code></span>（即<span><code class="racket parenthesis">(</code><code class="racket symbol">Syntaxof</code><code class="racket"> </code><code class="racket symbol">Syntax-E</code><code class="racket parenthesis">)</code></span>）代表可以序列化的 <em>2D Syntax</em> ，而<span><code class="racket parenthesis">(</code><code class="racket symbol">Syntaxof</code><code class="racket"> </code><code class="racket symbol">Any</code><code class="racket parenthesis">)</code></span>则包括了两者。</p>
   <p><em>3D Syntax</em> 有其用途，例如如果要编写一个调试器，就可以直接在Syntax Object里放入一个函数，让代码和UI进行跨越phase、namespace以及module registry的交互。而一个通用的宏，则应该避免使用 <em>3D Syntax</em> ，至少不能被保留到 <em>Fully Expanded Program</em> 里。</p>
   <h4 id="另一个例子">另一个例子</h4>
   <p>另一个可能比较有代表性的例子是scope的introducer，下面的<span><code class="racket symbol">within-a</code></span>实现了类似C++的命名空间效果：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket

</code><code class="racket parenthesis">(</code><code class="racket symbol">begin-for-syntax</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">a</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">make-syntax-introducer</code><code class="racket"> </code><code class="racket constant">#t</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">within-a</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">body</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket parenthesis">(</code><code class="racket symbol">with-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">body</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">a</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">body</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
       </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">begin</code><code class="racket"> </code><code class="racket symbol">body</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">0</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">within-a</code><code class="racket">
 </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">displayln</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket comment">;0</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">within-a</code><code class="racket">
 </code><code class="racket parenthesis">(</code><code class="racket symbol">displayln</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket comment">;1</code></pre></div>
   <p>同理，由于<span><code class="racket parenthesis">(</code><code class="racket symbol">make-syntax-introducer</code><code class="racket parenthesis">)</code></span>是“generative”的，在repl中就失效了：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket symbol">&gt;</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">within-a</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket constant">0</code></pre></div>
   <p>使用 <em>3D Syntax</em> ，直接把<span><code class="racket symbol">a</code></span>放进Syntax Object能有所改善：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">define-intro</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket constant">#`</code><code class="racket parenthesis">(</code><code class="racket symbol">begin-for-syntax</code><code class="racket">
         </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket">#,</code><code class="racket parenthesis">(</code><code class="racket symbol">make-syntax-introducer</code><code class="racket"> </code><code class="racket constant">#t</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-intro</code><code class="racket"> </code><code class="racket symbol">a</code><code class="racket parenthesis">)</code></pre></div>
   <p>但正如上文所说， <em>3D Syntax</em> 也有其自身的问题。这里正确的做法是使用<span><code class="racket symbol">make-syntax-delta-introducer</code></span>。</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">define-intro</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket parenthesis">(</code><code class="racket symbol">with-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">scopeless</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">datum-&gt;syntax</code><code class="racket"> </code><code class="racket constant">#f</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">k</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
       </code><code class="racket parenthesis">(</code><code class="racket symbol">with-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">scoped</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">(</code><code class="racket symbol">make-syntax-introducer</code><code class="racket"> </code><code class="racket constant">#t</code><code class="racket parenthesis">)</code><code class="racket">
                              </code><code class="racket constant">#'</code><code class="racket symbol">scopeless</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
         </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">begin-for-syntax</code><code class="racket">
             </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">cons</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">scoped</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">scopeless</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-intro</code><code class="racket"> </code><code class="racket symbol">a</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">within-a</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">body</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket parenthesis">(</code><code class="racket symbol">let</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">intro</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">make-syntax-delta-introducer</code><code class="racket">
                   </code><code class="racket parenthesis">(</code><code class="racket symbol">car</code><code class="racket"> </code><code class="racket symbol">a</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">cdr</code><code class="racket"> </code><code class="racket symbol">a</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
       </code><code class="racket parenthesis">(</code><code class="racket symbol">with-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">body</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">intro</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">body</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
         </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">begin</code><code class="racket"> </code><code class="racket symbol">body</code><code class="racket"> </code><code class="racket symbol">...</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">0</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">within-a</code><code class="racket">
 </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">displayln</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">within-a</code><code class="racket">
 </code><code class="racket parenthesis">(</code><code class="racket symbol">displayln</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code></pre></div>
   <p>通过一对 <em>identifier</em> ，一个应用过introducer，另一个没有，<span><code class="racket symbol">make-syntax-delta-introducer</code></span>能够还原出最初的introducer。而 <em>identifier</em> ，属于 <em>2D Syntax</em> 。</p>
   <p>可以看出，<span><code class="racket symbol">make-syntax-delta-introducer</code></span>提供了用 <em>2D Syntax</em> 表示任何“introducer”的方法。</p>
   <h3 id="局部的宏">局部的宏</h3>
   <p>局部的宏里，副作用的使用受到诸多限制：</p>
   <ul>
    <li>
     <p>Definition Context的两轮展开</p>
     <div class="outer">
      <pre class="brush: racket"><code class="racket parenthesis">(</code><code class="racket symbol">let</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">a</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">a</code><code class="racket"> </code><code class="racket constant">2</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">void</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">report-a</code><code class="racket parenthesis">)</code></pre></div>
     <p>注意到上述代码中，<span><code class="racket symbol">let</code></span>里面的<span><code class="racket symbol">a</code></span>没有被计入<span><code class="racket parenthesis">(</code><code class="racket symbol">report-a</code><code class="racket parenthesis">)</code></span>计入，这跟Definition Context的两轮展开有关系，可见<a href="local-expand.html#%E9%83%A8%E5%88%86%E5%B1%95%E5%BC%80-vs-%E5%AE%8C%E5%85%A8%E5%B1%95%E5%BC%80">部分展开 vs 完全展开</a>。</p>
     <p>一种变通手法是将<span><code class="racket parenthesis">(</code><code class="racket symbol">report-a</code><code class="racket parenthesis">)</code></span>改为<span><code class="racket parenthesis">(</code><code class="racket symbol">#%expression</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">report-a</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code></span>，将展开延迟到第二轮。这也并非万全之策，应避免副作用的顺序影响结果。</p></li>
    <li>
     <p>表达式上下文</p>
     <p>在表达式上下文里，<span><code class="racket symbol">begin-for-syntax</code></span>和<span><code class="racket symbol">define-syntaxes</code></span>都无法使用，只能回到一开始的直接在宏里执行副作用。因此在设计宏的时候，应避免局部的副作用对外部可见。</p></li></ul>
   <p>另一方面，局部的副作用也通常会被一个使用<span><code class="racket symbol">local-expand</code></span>做完全展开的宏消费掉，从而把副作用限制起来。</p>
   <h2 id="transformer-binding">Transformer Binding</h2>
   <p><span><code class="racket symbol">define-syntax</code></span>可以定义宏，但并不局限于定义宏，因为可以用<span><code class="racket symbol">syntax-local-value</code></span>访问<span><code class="racket symbol">define-syntax</code></span>定义的值，所以这也是一种通用定义编译期信息的手段。<span><code class="racket symbol">define-syntax</code></span>定义的 <em>binding</em> 在宏展开时可见，被称为 <em>Transformer Binding</em> 。</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket symbol">y</code><code class="racket"> </code><code class="racket constant">2</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket parenthesis">(</code><code class="racket symbol">if</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">eq?</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-value</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
         </code><code class="racket constant">#'</code><code class="racket constant">'</code><code class="racket symbol">foo</code><code class="racket">
         </code><code class="racket constant">#'</code><code class="racket constant">'</code><code class="racket symbol">bar</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket symbol">y</code><code class="racket parenthesis">)</code></pre></div>
   <p>这里<span><code class="racket symbol">x</code></span>和<span><code class="racket symbol">y</code></span>是 <em>Transformer Binding</em> ，<span><code class="racket symbol">f</code></span>在展开时可以检查<span><code class="racket symbol">id</code></span>的值是否为1，并选择对应的宏展开方法。</p>
   <p>这种方式的另一个优点是可以简单地用于local的binding：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket parenthesis">(</code><code class="racket symbol">let-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">z</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket symbol">z</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code></pre></div>
   <h3 id="一名多用">一名多用</h3>
   <p>有时候会希望定义的名字不仅用于记录信息，也可用作为宏或者普通函数使用。</p>
   <p>这个时候可以使用<span><code class="racket symbol">prop:procedure</code></span>，这个 <em>structure type property</em> 可以让struct能够作为函数使用：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket

</code><code class="racket parenthesis">(</code><code class="racket symbol">begin-for-syntax</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">struct</code><code class="racket"> </code><code class="racket symbol">info</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">data</code><code class="racket"> </code><code class="racket symbol">proc</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket hash-colon-keyword">#:property</code><code class="racket"> </code><code class="racket symbol">prop:procedure</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">struct-field-index</code><code class="racket"> </code><code class="racket symbol">proc</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">info</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-rules</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
                           </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">11</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket symbol">y</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">info</code><code class="racket"> </code><code class="racket constant">2</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-rules</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
                           </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">22</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket parenthesis">(</code><code class="racket symbol">if</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">eq?</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">info-data</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-value</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
         </code><code class="racket constant">#'</code><code class="racket constant">'</code><code class="racket symbol">foo</code><code class="racket">
         </code><code class="racket constant">#'</code><code class="racket constant">'</code><code class="racket symbol">bar</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket symbol">y</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">let-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">z</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">info</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-rules</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket symbol">z</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">y</code><code class="racket parenthesis">)</code></pre></div>
   <p>这样，当<span><code class="racket symbol">x</code></span>、<span><code class="racket symbol">y</code></span>和<span><code class="racket symbol">z</code></span>作为宏使用时，调用的是<span><code class="racket symbol">proc</code></span>字段的函数。可以得到</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket constant">'</code><code class="racket symbol">foo</code><code class="racket">
</code><code class="racket constant">'</code><code class="racket symbol">bar</code><code class="racket">
</code><code class="racket constant">'</code><code class="racket symbol">foo</code><code class="racket">
</code><code class="racket constant">11</code><code class="racket">
</code><code class="racket constant">22</code></pre></div>
   <h3 id="提高可组合性">提高可组合性</h3>
   <p>上面的struct用法有一个缺点，当两个不相关的库分别定义了<span><code class="racket symbol">info1</code></span>和<span><code class="racket symbol">info2</code></span>时，无法同时把一个名字用于他们的binding，因为一个值不能同时既是<span><code class="racket symbol">info1</code></span>类型又是<span><code class="racket symbol">info2</code></span>类型。因此，需要用 <em>structure type property</em> 作为信息设置的接口。</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket

</code><code class="racket parenthesis">(</code><code class="racket symbol">begin-for-syntax</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">define-values</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">prop:info</code><code class="racket"> </code><code class="racket symbol">info?</code><code class="racket"> </code><code class="racket symbol">info-ref</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">make-struct-type-property</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">info</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

  </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">info</code><code class="racket"> </code><code class="racket symbol">data</code><code class="racket"> </code><code class="racket symbol">proc</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">struct</code><code class="racket"> </code><code class="racket symbol">info</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">data</code><code class="racket"> </code><code class="racket symbol">proc</code><code class="racket parenthesis">)</code><code class="racket">
      </code><code class="racket hash-colon-keyword">#:property</code><code class="racket"> </code><code class="racket symbol">prop:info</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">struct-field-index</code><code class="racket"> </code><code class="racket symbol">data</code><code class="racket parenthesis">)</code><code class="racket">
      </code><code class="racket hash-colon-keyword">#:property</code><code class="racket"> </code><code class="racket symbol">prop:procedure</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">struct-field-index</code><code class="racket"> </code><code class="racket symbol">proc</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">info</code><code class="racket"> </code><code class="racket symbol">data</code><code class="racket"> </code><code class="racket symbol">proc</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">info</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-rules</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
                           </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">11</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket symbol">y</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">info</code><code class="racket"> </code><code class="racket constant">2</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-rules</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
                           </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">22</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket parenthesis">(</code><code class="racket symbol">if</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">eq?</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">info-ref</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-local-value</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
         </code><code class="racket constant">#'</code><code class="racket constant">'</code><code class="racket symbol">foo</code><code class="racket">
         </code><code class="racket constant">#'</code><code class="racket constant">'</code><code class="racket symbol">bar</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket symbol">y</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">let-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">z</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">info</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-rules</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket symbol">z</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">y</code><code class="racket parenthesis">)</code></pre></div>
   <p>这里定义了<span><code class="racket symbol">prop:info</code></span>作为接口，这样不需要固定使用某种struct，而是可以使用任何满足该property的值。</p>
   <p>同理，如果要同时用于<span><code class="racket symbol">info1</code></span>和<span><code class="racket symbol">info2</code></span>，只需要</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket parenthesis">(</code><code class="racket symbol">struct</code><code class="racket"> </code><code class="racket symbol">myinfo</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">a</code><code class="racket"> </code><code class="racket symbol">b</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket hash-colon-keyword">#:property</code><code class="racket"> </code><code class="racket symbol">prop:info1</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">struct-field-index</code><code class="racket"> </code><code class="racket symbol">a</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket hash-colon-keyword">#:property</code><code class="racket"> </code><code class="racket symbol">prop:info2</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">struct-field-index</code><code class="racket"> </code><code class="racket symbol">b</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code></pre></div>
   <h3 id="动态作用域">动态作用域</h3>
   <p><em>Syntax Parameter</em> 提供编译期的动态作用域，可以把它想象为<span><code class="racket symbol">local-expand</code></span>和普通的 <em>Parameter</em> 的组合，但它使用的是 <em>Transformer Binding</em> 。</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket
</code><code class="racket parenthesis">(</code><code class="racket symbol">require</code><code class="racket"> </code><code class="racket symbol">racket/stxparam</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax-parameter</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax-parameter</code><code class="racket"> </code><code class="racket symbol">y</code><code class="racket"> </code><code class="racket constant">2</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket parenthesis">(</code><code class="racket symbol">if</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">eq?</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-parameter-value</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
         </code><code class="racket constant">#'</code><code class="racket constant">'</code><code class="racket symbol">foo</code><code class="racket">
         </code><code class="racket constant">#'</code><code class="racket constant">'</code><code class="racket symbol">bar</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax-rule</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">foo-y</code><code class="racket"> </code><code class="racket symbol">expr</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-parameterize</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">y</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket symbol">expr</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket comment">;'foo</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket symbol">y</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket comment">;'bar</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">foo-y</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket symbol">y</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket comment">;'foo</code></pre></div>
   <h3 id="替代手段副作用和free-id-table">替代手段：副作用和free-id-table</h3>
   <p>free-id-table配合副作用，可以可以把信息关联到名字上，能代替 <em>Transformer Binding</em> 。更加方便的是，它可以把信息关联到已有的，甚至是其他module定义的名字上。同时由于局部的 <em>binding</em> 对外不可见，也不用担心局部的副作用顺序问题。</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket

</code><code class="racket parenthesis">(</code><code class="racket symbol">begin-for-syntax</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">require</code><code class="racket"> </code><code class="racket symbol">syntax/id-table</code><code class="racket"> </code><code class="racket symbol">racket/syntax</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">table</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">make-free-id-table</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">foo</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">y</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">bar</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket parenthesis">(</code><code class="racket symbol">if</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">eq?</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">free-id-table-ref</code><code class="racket"> </code><code class="racket symbol">table</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
         </code><code class="racket constant">#'</code><code class="racket constant">'</code><code class="racket symbol">ok</code><code class="racket">
         </code><code class="racket constant">#'</code><code class="racket constant">'</code><code class="racket symbol">bad</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">attach!</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">value</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntaxes</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
         </code><code class="racket parenthesis">(</code><code class="racket symbol">begin</code><code class="racket">
           </code><code class="racket parenthesis">(</code><code class="racket symbol">free-id-table-set!</code><code class="racket"> </code><code class="racket symbol">table</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">value</code><code class="racket parenthesis">)</code><code class="racket">
           </code><code class="racket parenthesis">(</code><code class="racket symbol">values</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">


</code><code class="racket parenthesis">(</code><code class="racket symbol">attach!</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">attach!</code><code class="racket"> </code><code class="racket symbol">y</code><code class="racket"> </code><code class="racket constant">2</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket symbol">y</code><code class="racket parenthesis">)</code></pre></div>
   <p>这种方法的缺陷是可以重复把信息关联到同一个名字上，造成隐患。但反过来说，这种特性也方便了增量式开发。</p>
   <h4 id="避免依赖">避免依赖</h4>
   <p>如果需要把信息关联到其他module的名字里：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket/base
</code><code class="racket parenthesis">(</code><code class="racket symbol">require</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">for-syntax</code><code class="racket"> </code><code class="racket symbol">racket/base</code><code class="racket">
                     </code><code class="racket symbol">syntax/id-table</code><code class="racket"> </code><code class="racket symbol">racket/syntax</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">begin-for-syntax</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">table</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">make-free-id-table</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket parenthesis">(</code><code class="racket symbol">if</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">eq?</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">free-id-table-ref</code><code class="racket"> </code><code class="racket symbol">table</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
         </code><code class="racket constant">#'</code><code class="racket constant">'</code><code class="racket symbol">ok</code><code class="racket">
         </code><code class="racket constant">#'</code><code class="racket constant">'</code><code class="racket symbol">bad</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">attach!</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">value</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntaxes</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
         </code><code class="racket parenthesis">(</code><code class="racket symbol">begin</code><code class="racket">
           </code><code class="racket parenthesis">(</code><code class="racket symbol">free-id-table-set!</code><code class="racket"> </code><code class="racket symbol">table</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">value</code><code class="racket parenthesis">)</code><code class="racket">
           </code><code class="racket parenthesis">(</code><code class="racket symbol">values</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">require</code><code class="racket"> </code><code class="racket symbol">racket/match</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">attach!</code><code class="racket"> </code><code class="racket symbol">match</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket symbol">match</code><code class="racket parenthesis">)</code></pre></div>
   <p>没有问题，但是这也带来了对<span><code class="racket symbol">racket/match</code></span>的依赖，即便没有<span><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket symbol">match</code><code class="racket parenthesis">)</code></span>也是如此。若不<span><code class="racket parenthesis">(</code><code class="racket symbol">require</code><code class="racket"> </code><code class="racket symbol">racket/match</code><code class="racket parenthesis">)</code></span>，则无法建立正确的binding：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket parenthesis">(</code><code class="racket symbol">attach!</code><code class="racket"> </code><code class="racket symbol">match</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">module+</code><code class="racket"> </code><code class="racket symbol">main</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">require</code><code class="racket"> </code><code class="racket symbol">racket/match</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket symbol">match</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket comment">;; free-id-table-ref: no mapping for #&lt;syntax:unsaved-editor:32:5 match&gt;</code></pre></div>
   <p>这个时候可以使用Racket 7引入的<span><code class="racket symbol">syntax-binding-set</code></span>：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">attach-loosely!</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">mod</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">value</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket parenthesis">(</code><code class="racket symbol">with-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-binding-set-&gt;syntax</code><code class="racket">
                        </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-binding-set-extend</code><code class="racket">
                         </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-binding-set</code><code class="racket parenthesis">)</code><code class="racket">
                         </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-&gt;datum</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket">
                         </code><code class="racket parenthesis">(</code><code class="racket symbol">variable-reference-&gt;module-base-phase</code><code class="racket">
                          </code><code class="racket parenthesis">(</code><code class="racket symbol">#%variable-reference</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
                         </code><code class="racket parenthesis">(</code><code class="racket symbol">module-path-index-join</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-&gt;datum</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">mod</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">#f</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
                        </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-&gt;datum</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">id</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
       </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">begin-for-syntax</code><code class="racket">
           </code><code class="racket parenthesis">(</code><code class="racket symbol">free-id-table-set!</code><code class="racket"> </code><code class="racket symbol">table</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">value</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">attach-loosely!</code><code class="racket"> </code><code class="racket symbol">racket/match/match</code><code class="racket"> </code><code class="racket symbol">match</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">module+</code><code class="racket"> </code><code class="racket symbol">main</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">require</code><code class="racket"> </code><code class="racket symbol">racket/match</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket symbol">match</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code></pre></div>
   <p>这种方法自身不会引入依赖，只有用户确实要用到<span><code class="racket symbol">match</code></span>的时候才会引入依赖。</p>
   <p>另外，注意到这里的的mod参数是<span><code class="racket symbol">racket/match/match</code></span>，这是一个缺点，它需要精确知道<span><code class="racket symbol">match</code></span>的定义所在的module，而不仅是<span><code class="racket symbol">require</code></span>所需的module。</p>
   <hr />
   <p>在Racket7之前的版本中，也可以采用取巧的方法实现这个功能。Typed Racket源码中有一个类似的<span><code class="racket symbol">make-template-identifier</code></span>函数可以参考：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">make-template-identifier</code><code class="racket"> </code><code class="racket symbol">what</code><code class="racket"> </code><code class="racket symbol">where</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">let</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">name</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">module-path-index-resolve</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">module-path-index-join</code><code class="racket"> </code><code class="racket symbol">where</code><code class="racket"> </code><code class="racket constant">#f</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">(</code><code class="racket symbol">parameterize</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">current-namespace</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">make-empty-namespace</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
      </code><code class="racket parenthesis">(</code><code class="racket symbol">namespace-attach-module</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">current-namespace</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket constant">'</code><code class="racket symbol">#%kernel</code><code class="racket parenthesis">)</code><code class="racket">
      </code><code class="racket parenthesis">(</code><code class="racket symbol">parameterize</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">current-module-declare-name</code><code class="racket"> </code><code class="racket symbol">name</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
        </code><code class="racket parenthesis">(</code><code class="racket symbol">eval</code><code class="racket"> </code><code class="racket constant">`</code><code class="racket parenthesis">(</code><code class="racket">,</code><code class="racket constant">#'</code><code class="racket symbol">module</code><code class="racket"> </code><code class="racket symbol">any</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">#%kernel</code><code class="racket">
                 </code><code class="racket parenthesis">(</code><code class="racket symbol">#%provide</code><code class="racket"> ,</code><code class="racket symbol">what</code><code class="racket parenthesis">)</code><code class="racket">
                 </code><code class="racket parenthesis">(</code><code class="racket symbol">define-values</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket">,</code><code class="racket symbol">what</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">#f</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
      </code><code class="racket parenthesis">(</code><code class="racket symbol">namespace-require</code><code class="racket"> </code><code class="racket constant">`</code><code class="racket parenthesis">(</code><code class="racket symbol">for-template</code><code class="racket"> ,</code><code class="racket symbol">name</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
      </code><code class="racket parenthesis">(</code><code class="racket symbol">namespace-syntax-introduce</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">datum-&gt;syntax</code><code class="racket"> </code><code class="racket constant">#f</code><code class="racket"> </code><code class="racket symbol">what</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code></pre></div>
   <h2 id="syntax-property">Syntax Property</h2>
   <h3 id="reader和syntax-property">Reader和Syntax Property</h3>
   <p>Reader可以添加syntax property，典型例子有<span><code class="racket constant">'</code><code class="racket symbol">paren-shape</code></span>和<span><code class="racket symbol">syntax-original?</code></span>。另外，Typed Racket也定义了一系列用于附加类型信息的Reader扩展。</p>
   <p>示例（保存为”a.rkt“）：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket/base
</code><code class="racket parenthesis">(</code><code class="racket symbol">provide</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">rename-out</code><code class="racket"> </code><code class="racket parenthesis">[</code><code class="racket symbol">read-syntax*</code><code class="racket"> </code><code class="racket symbol">read-syntax</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">read-syntax*</code><code class="racket"> </code><code class="racket symbol">source</code><code class="racket"> </code><code class="racket symbol">in</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">read-syntax</code><code class="racket"> </code><code class="racket symbol">source</code><code class="racket"> </code><code class="racket symbol">in</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">sym</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-&gt;datum</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">read-syntax</code><code class="racket"> </code><code class="racket symbol">source</code><code class="racket"> </code><code class="racket symbol">in</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">val</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-&gt;datum</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">read-syntax</code><code class="racket"> </code><code class="racket symbol">source</code><code class="racket"> </code><code class="racket symbol">in</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-property</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket symbol">sym</code><code class="racket"> </code><code class="racket symbol">val</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code></pre></div>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket parenthesis">(</code><code class="racket symbol">if</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-property</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">readed!</code><code class="racket parenthesis">)</code><code class="racket">
         </code><code class="racket constant">#'</code><code class="racket constant">1</code><code class="racket">
         </code><code class="racket constant">#'</code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> #reader </code><code class="racket string">"a.rkt"</code><code class="racket constant">100</code><code class="racket"> </code><code class="racket symbol">readed!</code><code class="racket"> </code><code class="racket constant">#t</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket comment">;; 1</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket constant">100</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket comment">;; 100</code></pre></div>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang typed/racket

</code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> #reader </code><code class="racket string">"a.rkt"</code><code class="racket"> </code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket symbol">type-label</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">Option</code><code class="racket"> </code><code class="racket symbol">Integer</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">100</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket comment">;; &gt; f</code><code class="racket">
</code><code class="racket comment">;; - : (U False Integer)</code><code class="racket">
</code><code class="racket comment">;; 100</code></pre></div>
   <p>有时候需要让Syntax Property的值也是一个Syntax Object，并且拥有与所属的Syntax Object一样的上下文信息，那么Reader直接附加信息的方法就不太适用了。</p>
   <p>替代方案是Reader将其改写为宏调用，再在宏里附加Syntax Property，这是Typed Racket对<span><code class="racket parenthesis">#{</code><code class="racket symbol">e</code><code class="racket"> </code><code class="racket symbol">::</code><code class="racket"> </code><code class="racket symbol">t</code><code class="racket parenthesis">}</code></span>到<span><code class="racket parenthesis">(</code><code class="racket symbol">ann</code><code class="racket"> </code><code class="racket symbol">e</code><code class="racket"> </code><code class="racket symbol">t</code><code class="racket parenthesis">)</code></span>形式的处理方法。这种方法有不卫生的风险：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang typed/racket
</code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">ann</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">#{</code><code class="racket constant">1</code><code class="racket"> </code><code class="racket symbol">::</code><code class="racket"> </code><code class="racket symbol">Integer</code><code class="racket parenthesis">}</code></pre></div>
   <p>这个Typed Racket程序因为Reader引入的<span><code class="racket symbol">ann</code></span>解析到用户定义的那个，所以不能正常工作。</p>
   <h3 id="宏和syntax-property">宏和Syntax Property</h3>
   <p>由于宏展开是由外到内的，正常情况下一个宏是不能利用作为参数的表达式的Syntax Property的。</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">a</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">expr</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-property</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">expr</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">foo</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">bar</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">expr</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket parenthesis">(</code><code class="racket symbol">with-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">foo</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-property</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">expr</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">foo</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
       </code><code class="racket constant">#'</code><code class="racket constant">'</code><code class="racket symbol">foo</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">a</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code></pre></div>
   <p>只能得到<span><code class="racket constant">#f</code></span>。</p>
   <p>如果要利用宏附加的Syntax Property，基本上有两种途径：</p>
   <ol>
    <li>
     <p>在 <em>Fully Expanded Program</em> 上操作，例子是DrRacket的Check Syntax。（另见<a href="draw-arrow.html">如何让DrRacket正确地画出箭头</a>）</p>
     <p>遍历一个 <em>Fully Expanded Program</em> 的方法可以看<a href="phase-match.html#%E5%8C%B9%E9%85%8Dfully-expanded-program">Phase 与 identifier的匹配</a>。</p></li>
    <li>
     <p>外层的宏使用<span><code class="racket symbol">local-expand</code></span>。（另见<a href="local-expand.html">local-expand该怎么用</a>）</p>
     <p>这方面最典型的例子是<a href="https://www.ccs.neu.edu/home/stchang/pubs/ckg-popl2017.pdf">Type Systems as Macros</a>。</p></li></ol>
   <p>下面讨论<span><code class="racket symbol">local-expand</code></span>的情况需要注意的点。</p>
   <h4 id="展开为表达式">展开为表达式</h4>
   <p>就像在<a href="local-expand.html">local-expand该怎么用</a>提到的，完全展开要延迟到 <em>expression context</em> ，上面的<span><code class="racket symbol">f</code></span>需要改为：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket
</code><code class="racket parenthesis">(</code><code class="racket symbol">require</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">for-syntax</code><code class="racket"> </code><code class="racket symbol">syntax/transformer</code><code class="racket"> </code><code class="racket symbol">racket/syntax</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">a</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">expr</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-property</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">expr</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">foo</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">bar</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket symbol">f</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">make-expression-transformer</code><code class="racket">
   </code><code class="racket parenthesis">(</code><code class="racket symbol">λ</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
       </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">expr</code><code class="racket parenthesis">)</code><code class="racket">
        </code><code class="racket parenthesis">(</code><code class="racket symbol">with-syntax*</code><code class="racket">
            </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">expr</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">local-expand</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">expr</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">expression</code><code class="racket"> </code><code class="racket symbol">null</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket">
             </code><code class="racket parenthesis">[</code><code class="racket symbol">foo</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-property</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">expr</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">foo</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
          </code><code class="racket constant">#'</code><code class="racket constant">'</code><code class="racket symbol">foo</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">a</code><code class="racket"> </code><code class="racket constant">1</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code></pre></div>
   <p>可以得到<span><code class="racket constant">'</code><code class="racket symbol">bar</code></span>。</p>
   <h4 id="展开为定义">展开为定义</h4>
   <p>同样，当<span><code class="racket symbol">f</code></span>展开为定义时，是不能用完全展开的：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket
</code><code class="racket parenthesis">(</code><code class="racket symbol">require</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">for-syntax</code><code class="racket"> </code><code class="racket symbol">syntax/transformer</code><code class="racket"> </code><code class="racket symbol">racket/syntax</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">a</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">expr</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-property</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">expr</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">foo</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">bar</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">expr</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket parenthesis">(</code><code class="racket symbol">with-syntax*</code><code class="racket">
         </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">expr</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">local-expand</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">expr</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">expression</code><code class="racket"> </code><code class="racket symbol">null</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket">
          </code><code class="racket parenthesis">[</code><code class="racket symbol">foo</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-property</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">expr</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">foo</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
       </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">foo</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">a</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">dummy</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">dummy</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">0</code><code class="racket parenthesis">)</code></pre></div>
   <p>会导致“unbound identifier”。针对上面的例子，可以用一个辅助宏延迟展开：</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">f-helper</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">expr</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket parenthesis">(</code><code class="racket symbol">with-syntax*</code><code class="racket">
         </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">expr</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">local-expand</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">expr</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">expression</code><code class="racket"> </code><code class="racket symbol">null</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket">
          </code><code class="racket parenthesis">[</code><code class="racket symbol">foo</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-property</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">expr</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">foo</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
       </code><code class="racket constant">#'</code><code class="racket constant">'</code><code class="racket symbol">foo</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax-rule</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">expr</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">f-helper</code><code class="racket"> </code><code class="racket symbol">expr</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code></pre></div>
   <h4 id="按名字传播syntax-property">按名字传播Syntax Property</h4>
   <p>有时候需要模仿关联到名字的方式，让对一个名字的使用都带有某个Syntax Property，这个时候就要用“variable-like”宏了。</p>
   <div class="outer">
    <pre class="brush: racket"><code class="racket">#lang racket
</code><code class="racket parenthesis">(</code><code class="racket symbol">require</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">for-syntax</code><code class="racket"> </code><code class="racket symbol">syntax/transformer</code><code class="racket"> </code><code class="racket symbol">racket/syntax</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">a</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">expr</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-property</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">expr</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">foo</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">bar</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket symbol">f</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">make-expression-transformer</code><code class="racket">
   </code><code class="racket parenthesis">(</code><code class="racket symbol">λ</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
       </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">expr</code><code class="racket parenthesis">)</code><code class="racket">
        </code><code class="racket parenthesis">(</code><code class="racket symbol">with-syntax*</code><code class="racket">
            </code><code class="racket parenthesis">(</code><code class="racket parenthesis">[</code><code class="racket symbol">expr</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">local-expand</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">expr</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">expression</code><code class="racket"> </code><code class="racket symbol">null</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket">
             </code><code class="racket parenthesis">[</code><code class="racket symbol">foo</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-property</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">expr</code><code class="racket"> </code><code class="racket constant">'</code><code class="racket symbol">foo</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket">
          </code><code class="racket constant">#'</code><code class="racket constant">'</code><code class="racket symbol">foo</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">define-a</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
  </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
    </code><code class="racket parenthesis">[</code><code class="racket parenthesis">(</code><code class="racket symbol">_</code><code class="racket"> </code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">expr</code><code class="racket parenthesis">)</code><code class="racket">
     </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">begin</code><code class="racket">
         </code><code class="racket parenthesis">(</code><code class="racket symbol">define</code><code class="racket"> </code><code class="racket symbol">tmp</code><code class="racket"> </code><code class="racket symbol">expr</code><code class="racket parenthesis">)</code><code class="racket">
         </code><code class="racket parenthesis">(</code><code class="racket symbol">define-syntax</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">id</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket parenthesis">)</code><code class="racket">
           </code><code class="racket parenthesis">(</code><code class="racket symbol">syntax-case</code><code class="racket"> </code><code class="racket symbol">stx</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket parenthesis">)</code><code class="racket">
             </code><code class="racket parenthesis">[</code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">identifier?</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket"> </code><code class="racket constant">#'</code><code class="racket parenthesis">(</code><code class="racket symbol">a</code><code class="racket"> </code><code class="racket symbol">tmp</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket parenthesis">]</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code><code class="racket">

</code><code class="racket parenthesis">(</code><code class="racket symbol">define-a</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket"> </code><code class="racket constant">0</code><code class="racket parenthesis">)</code><code class="racket">
</code><code class="racket parenthesis">(</code><code class="racket symbol">displayln</code><code class="racket"> </code><code class="racket parenthesis">(</code><code class="racket symbol">f</code><code class="racket"> </code><code class="racket symbol">x</code><code class="racket parenthesis">)</code><code class="racket parenthesis">)</code></pre></div></div></body></html>